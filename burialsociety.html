<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Burial Society Management</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<style>
  :root {
    --primary: #2c3e50;
    --secondary: #3498db;
    --accent: #e74c3c;
    --success: #27ae60;
    --warning: #f39c12;
    --light: #34495e;
    --dark: #ecf0f1;
    --text: #ecf0f1;
    --text-light: #bdc3c7;
    --bg: #1a1f29;
    --card-bg: #2c3e50;
    --nav-bg: #2c3e50;
    --shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    --shadow-hover: 0 10px 30px rgba(0, 0, 0, 0.25);
    --danger-red: #fc8181;
  }

  * { 
    margin: 0; 
    padding: 0; 
    box-sizing: border-box; 
  }
  
  body { 
    background: var(--bg); 
    color: var(--text); 
    transition: all 0.3s ease;
    line-height: 1.6;
    min-height: 100vh;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }

  .app-container {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  nav { 
    display: flex; 
    justify-content: flex-start; 
    align-items: center; 
    background: var(--nav-bg); 
    padding: 0.8rem 2rem; 
    box-shadow: var(--shadow);
    position: sticky; 
    top: 0; 
    z-index: 100;
    transition: all 0.3s ease;
  }
  
  .logo-container {
    display: flex;
    align-items: center;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .logo {
    height: 60px;
    width: auto;
    transition: all 0.3s ease;
    border-radius: 8px;
    background: transparent;
    display: block;
  }
  
  .logo.expanded {
    height: 120px;
  }
  
  nav ul { 
    list-style: none; 
    display: flex; 
    gap: 1.5rem; 
    margin: 0 auto; /* center nav items */
  }
  
  nav ul li a { 
    text-decoration: none; 
    color: var(--text); 
    font-weight: 500; 
    transition: all 0.3s ease;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  nav ul li a:hover { 
    color: var(--secondary);
    background: rgba(52, 152, 219, 0.1);
  }

  .nav-right {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .hero { 
    text-align: center; 
    padding: 5rem 2rem; 
    background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%);
    color: white; 
    position: relative;
    overflow: hidden;
  }
  
  .hero::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%23ffffff' fill-opacity='0.1' d='M0,224L48,213.3C96,203,192,181,288,160C384,139,480,117,576,122.7C672,128,768,160,864,170.7C960,181,1056,171,1152,165.3C1248,160,1344,160,1392,160L1440,160L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E");
    background-size: cover;
    background-position: center;
  }
  
  .hero-content {
    position: relative;
    z-index: 2;
    max-width: 800px;
    margin: 0 auto;
  }
  
  .hero h2 { 
    font-size: 2.8rem; 
    margin-bottom: 1rem; 
    font-weight: 800;
  }
  
  .hero p { 
    font-size: 1.2rem; 
    opacity: 0.9; 
    margin-bottom: 2rem;
  }

  .container { 
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
    gap: 2rem; 
    padding: 3rem 2rem; 
    max-width: 1200px;
    margin: 0 auto;
  }
  
  .card { 
    background: var(--card-bg); 
    padding: 2rem; 
    border-radius: 16px; 
    box-shadow: var(--shadow);
    transition: all 0.3s ease; 
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    border-left: 4px solid var(--secondary);
  }
  
  .card:hover { 
    transform: translateY(-8px); 
    box-shadow: var(--shadow-hover);
    border-left: 4px solid var(--accent);
  }
  
  .card h3 { 
    color: var(--secondary); 
    margin-bottom: 1rem;
    font-size: 1.4rem;
    display: flex;
    align-items: center;
    gap: 0.8rem;
  }
  
  .card p { 
    color: var(--text-light);
    line-height: 1.6;
  }

  .card-icon {
    background: var(--secondary);
    color: white;
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1.2rem;
    font-size: 1.2rem;
  }

  .content { 
    padding: 2.5rem; 
    display: none; 
    animation: fadeIn 0.4s ease; 
    transition: all 0.3s ease;
    max-width: 1200px;
    margin: 0 auto;
    width: 100%;
  }
  
  .content.active { 
    display: block; 
  }
  
  @keyframes fadeIn { 
    from { opacity: 0; transform: translateY(20px); } 
    to { opacity: 1; transform: translateY(0); } 
  }

  .section-header {
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .section-header h2 {
    font-size: 2rem;
    color: var(--secondary);
    display: flex;
    align-items: center;
    gap: 0.8rem;
  }

  .export-buttons {
    display: flex;
    gap: 0.8rem;
  }

  .form-search-container { 
    display: flex; 
    flex-wrap: wrap; 
    gap: 1.5rem; 
    margin-top: 1.5rem; 
    align-items: flex-start; 
  }
  
  #memberForm { 
    display: flex; 
    flex-wrap: wrap; 
    gap: 1rem; 
    flex: 1 1 600px; 
    background: var(--card-bg);
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: var(--shadow);
  }
  
  #memberForm input, 
  #memberSearch, 
  #memberForm select {
    flex: 1 1 180px;
    min-width: 120px;
    max-width: 300px;
    padding: 0.8rem 1.2rem;
    font-size: 1rem;
    border: 1px solid #555;
    border-radius: 8px;
    transition: all 0.3s ease;
    background: var(--card-bg);
    color: var(--text);
  }

  #memberForm input:focus,
  #memberSearch:focus {
    outline: none;
    border-color: var(--secondary);
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
  }
  
  #memberForm button {
    flex: 0 0 auto;
    padding: 0.8rem 1.5rem;
    font-size: 1rem;
    border-radius: 8px;
    cursor: pointer;
    border: none;
    transition: all 0.3s ease;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  #paymentForm {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    background: var(--card-bg);
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: var(--shadow);
    margin-bottom: 1.5rem;
  }

  #paymentForm input,
  #paymentForm select {
    padding: 0.8rem 1.2rem;
    font-size: 1rem;
    border: 1px solid #555;
    border-radius: 8px;
    transition: all 0.3s ease;
    background: var(--card-bg);
    color: var(--text);
  }

  #paymentForm input:focus,
  #paymentForm select:focus {
    outline: none;
    border-color: var(--secondary);
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
  }

  .add-btn-green { 
    background: var(--success); 
    color: #fff; 
  }
  
  .add-btn-green:hover {
    background: #219653;
    transform: translateY(-2px);
  }

  .update-btn-blue { 
    background: var(--secondary); 
    color: #fff; 
  }

  .update-btn-blue:hover {
    background: #2980b9;
    transform: translateY(-2px);
  }

  .export-btn {
    background: var(--primary);
    color: white;
    border: none;
    padding: 0.6rem 1.2rem;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 500;
  }

  .export-btn:hover {
    background: #1e2a38;
    transform: translateY(-2px);
  }

  #memberSearch {
    flex: 1;
    max-width: 400px;
    min-width: 200px;
  }

  table { 
    width: 100%; 
    border-collapse: separate;
    border-spacing: 0;
    margin-top: 2rem;
    background: var(--card-bg);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: var(--shadow);
  }
  
  table th, table td { 
    padding: 1rem; 
    text-align: left; 
    vertical-align: middle; 
  }
  
  table th { 
    background: var(--secondary);
    color: white;
    font-weight: 600;
    padding: 1.2rem 1rem;
  }

  table tr:nth-child(even) {
    background: rgba(255,255,255,0.05);
  }

  table tr:hover {
    background: rgba(52, 152, 219, 0.1);
  }
  
  #payments table th:last-child,
  #payments table td:last-child {
    text-align: center;
    color: var(--success);
    font-weight: bold;
  }
  
  #payments table td:nth-child(4) {
    white-space: nowrap;
    min-width: 120px;
  }
  
  button.edit-btn { 
    background: var(--warning); 
    color: white; 
    border: none; 
    padding: 0.5rem 1rem; 
    border-radius: 6px; 
    cursor: pointer; 
    margin-right: 0.5rem;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
  }

  button.edit-btn:hover {
    background: #e67e22;
    transform: translateY(-2px);
  }
  
  button.delete-btn { 
    background: var(--accent); 
    color: white; 
    border: none; 
    padding: 0.5rem 1rem; 
    border-radius: 6px; 
    cursor: pointer; 
    margin-right: 0.5rem;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
  }

  button.delete-btn:hover {
    background: #c0392b;
    transform: translateY(-2px);
  }
  
  button.beneficiary-btn { 
    background: var(--success); 
    color: white; 
    border: none; 
    padding: 0.5rem 1rem; 
    border-radius: 6px; 
    cursor: pointer; 
    margin-right: 0.5rem;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
  }

  button.beneficiary-btn:hover {
    background: #219653;
    transform: translateY(-2px);
  }
  
  #payments table th:last-child {
    background: var(--secondary) !important;
    color: white !important;
  }

  #payments table .edit-btn {
    background: var(--warning) !important;
    color: white !important;
  }

  #payments table .delete-btn {
    background: var(--accent) !important;
    color: white !important;
  }

  #payments table .edit-btn:hover {
    background: #e67e22 !important;
  }

  #payments table .delete-btn:hover {
    background: #c0392b !important;
  }
  
  .beneficiaries-list { 
    font-size: 0.95rem; 
  }
  
  .beneficiary-id {
    font-size: 0.85rem;
    color: var(--text-light);
    margin-top: 4px;
  }
  
  .small-muted { 
    font-size: 0.9rem; 
    color: var(--text-light); 
    margin-top: 0.5rem; 
  }

  .payment-status {
    display: inline-block;
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
  }
  
  .status-paid {
    background-color: rgb(0, 0, 0);
    color: #27ae60;
  }
  
  .status-pending {
    background-color: rgba(243, 156, 18, 0.15);
    color: #f39c12;
  }
  
  .status-overdue {
    background-color: rgb(0, 0, 0);
    color: var(--danger-red);
    border: 1px solid rgb(0, 0, 0);
  }

  .summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }
  
  .summary-card {
    background: var(--card-bg);
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: var(--shadow);
    text-align: center;
    position: relative;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .summary-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-hover);
  }
  
  .summary-card h3 {
    font-size: 1rem;
    color: var(--text-light);
    margin-bottom: 0.5rem;
  }
  
  .summary-card .amount {
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--secondary);
  }
  
  .summary-card.total {
    text-align: right;
    padding-right: 2rem;
  }
  
  .summary-card.total .amount {
    color: var(--success);
    font-weight: bold;
  }

  .expandable-section {
    margin-bottom: 1.5rem;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: var(--shadow);
    background: var(--card-bg);
  }
  
  .expandable-header {
    padding: 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: all 0.3s ease;
    user-select: none;
  }
  
  .expandable-header:hover {
    background: rgba(52, 152, 219, 0.05);
  }
  
  .expandable-header h3 {
    color: var(--secondary);
    display: flex;
    align-items: center;
    gap: 0.8rem;
    margin: 0;
  }
  
  .expandable-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.5s ease;
    background: var(--card-bg);
  }
  
  .expandable-content.expanded {
    max-height: 5000px;
  }
  
  .expandable-content-inner {
    padding: 1.5rem;
    border-top: 1px solid rgba(255,255,255,0.1);
  }

  .expandable-header .expand-icon {
    transition: transform 0.3s ease;
  }

  .expandable-header.expanded .expand-icon {
    transform: rotate(180deg);
  }

  .reports-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
    margin: 2rem 0;
  }
  
  .report-card {
    background: var(--card-bg);
    padding: 2.5rem;
    border-radius: 16px;
    box-shadow: var(--shadow);
    transition: all 0.3s ease;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    border-left: 6px solid var(--secondary);
    text-align: left;
    height: 100%;
    min-height: 220px;
  }
  
  .report-card:hover {
    transform: translateY(-8px);
    box-shadow: var(--shadow-hover);
    border-left: 6px solid var(--accent);
  }
  
  .report-card h3 {
    color: var(--secondary);
    margin-bottom: 1.2rem;
    font-size: 1.6rem;
    display: flex;
    align-items: center;
    gap: 0.8rem;
  }
  
  .report-card p {
    color: var(--text-light);
    line-height: 1.7;
    flex-grow: 1;
    font-size: 1.1rem;
  }
  
  .report-icon {
    background: var(--secondary);
    color: white;
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1.2rem;
    font-size: 1.4rem;
  }
  
  .report-card.warning {
    border-left: 6px solid var(--warning);
  }
  
  .report-card.warning .report-icon {
    background: var(--warning);
  }
  
  .report-card.danger {
    border-left: 6px solid var(--accent);
  }
  
  .report-card.danger .report-icon {
    background: var(--accent);
  }
  
  .report-card.success {
    border-left: 6px solid var(--success);
  }
  
  .report-card.success .report-icon {
    background: var(--success);
  }

  .quick-actions {
    display: flex;
    gap: 1rem;
    margin: 1.5rem 0;
    flex-wrap: nowrap;
    align-items: center;
    overflow-x: auto;
    padding-bottom: 0.5rem;
  }
  
  .quick-action-btn {
    background: var(--primary);
    color: white;
    border: none;
    padding: 0.8rem 1.5rem;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    white-space: nowrap;
    flex-shrink: 0;
  }
  
  .quick-action-btn:hover {
    background: #1e2a38;
    transform: translateY(-2px);
  }
  
  .quick-action-btn.warning {
    background: var(--warning);
  }
  
  .quick-action-btn.warning:hover {
    background: #e67e22;
  }
  
  .quick-action-btn.success {
    background: var(--success);
  }
  
  .quick-action-btn.success:hover {
    background: #219653;
  }

  .report-actions {
    display: flex;
    gap: 1rem;
    margin: 1.5rem 0;
    flex-wrap: nowrap;
    align-items: center;
    overflow-x: auto;
    padding-bottom: 0.5rem;
  }

  .statement-actions {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: nowrap;
    align-items: center;
    overflow-x: auto;
    padding-bottom: 0.5rem;
  }

  .flagged-member {
    background: var(--card-bg) !important;
    border-left: 4px solid var(--accent) !important;
  }
  
  .flagged-member td:first-child {
    font-weight: bold;
    color: var(--accent) !important;
  }

  .status-badge {
    display: inline-block;
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
  }
  
  .status-flagged {
    background-color: rgba(231, 76, 60, 0.15);
    color: #e74c3c;
  }

  .modal {
    display: none;
    position: fixed; 
    top: 0; 
    left: 0; 
    right: 0; 
    bottom: 0;
    background: rgba(0,0,0,0.7);
    justify-content: center; 
    align-items: center; 
    z-index: 1000;
    backdrop-filter: blur(5px);
    animation: fadeIn 0.3s ease;
  }
  
  .modal-content {
    background: var(--card-bg); 
    color: var(--text); 
    padding: 2rem; 
    border-radius: 16px; 
    width: 90%;
    max-width: 700px;
    text-align: center; 
    box-shadow: var(--shadow-hover);
    animation: slideUp 0.4s ease;
    border: 1px solid rgba(255,255,255,0.1);
  }

  @keyframes slideUp {
    from { opacity: 0; transform: translateY(40px); } 
    to { opacity: 1; transform: translateY(0); } 
  }
  
  .modal-buttons { 
    margin-top: 1.5rem; 
    display: flex; 
    gap: 0.8rem; 
    justify-content: center; 
  }
  
  .btn { 
    padding: 0.8rem 1.5rem; 
    border-radius: 8px; 
    cursor: pointer; 
    font-weight: 600; 
    border: none;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .btn-ghost { 
    background: transparent; 
    border: 1px solid #555; 
    color: var(--text); 
  }
  
  .btn-ghost:hover {
    background: rgba(255,255,255,0.05);
  }
  
  .btn-primary { 
    background: var(--secondary); 
    color: white; 
  }

  .btn-primary:hover {
    background: #2980b9;
    transform: translateY(-2px);
  }
  
  .btn-green { 
    background: var(--success); 
    color: white; 
  }

  .btn-green:hover {
    background: #219653;
    transform: translateY(-2px);
  }

  .btn-orange {
    background: var(--warning);
    color: white;
  }

  .btn-orange:hover {
    background: #e67e22;
    transform: translateY(-2px);
  }

  .btn-red {
    background: var(--accent);
    color: white;
  }

  .btn-red:hover {
    background: #c0392b;
    transform: translateY(-2px);
  }

  footer {
    background: var(--nav-bg);
    color: var(--text);
    text-align: center;
    padding: 1.5rem;
    margin-top: auto;
    box-shadow: 0 -4px 12px rgba(0,0,0,0.05);
  }

  .back-button {
    background: var(--primary);
    color: white;
    border: none;
    padding: 0.8rem 1.5rem;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
  }

  .back-button:hover {
    background: #1e2a38;
    transform: translateY(-2px);
  }

  .report-content { 
    padding: 2.5rem; 
    display: none; 
    animation: fadeIn 0.4s ease; 
    transition: all 0.3s ease;
    max-width: 1200px;
    margin: 0 auto;
    width: 100%;
  }
  
  .report-content.active { 
    display: block; 
  }
  
  .report-header {
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .report-header h2 {
    font-size: 2rem;
    color: var(--secondary);
    display: flex;
    align-items: center;
    gap: 0.8rem;
  }

  .reports-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
    padding: 2rem 0;
  }

  .report-card-arrow {
    margin-top: 1rem;
    color: var(--text-light);
    font-size: 1.2rem;
    transition: all 0.3s ease;
  }

  .report-card:hover .report-card-arrow {
    transform: translateX(5px);
    color: var(--secondary);
  }

  #reports .tabs {
    display: none;
  }

  #reports .tab-content {
    display: none !important;
  }

  .custom-select {
    position: relative;
    display: inline-block;
    width: 100%;
  }

  .custom-select select {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    padding-right: 2.5rem;
  }

  .custom-select::after {
    content: '\f078';
    font-family: 'Font Awesome 5 Free';
    font-weight: 900;
    position: absolute;
    top: 50%;
    right: 1rem;
    transform: translateY(-50%);
    pointer-events: none;
    color: var(--text-light);
  }

  .progress-container {
    margin-bottom: 2rem;
    background: var(--card-bg);
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: var(--shadow);
    border: 1px solid rgba(255,255,255,0.1);
  }

  .progress-bar {
    height: 30px;
    background-color: #34495e;
    border-radius: 15px;
    overflow: hidden;
    margin-bottom: 0.5rem;
    position: relative;
    border: 2px solid rgba(255,255,255,0.1);
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--success), #2ecc71);
    border-radius: 15px;
    transition: width 0.5s ease;
    position: relative;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
  }

  .progress-text {
    display: flex;
    justify-content: space-between;
    font-size: 0.9rem;
    color: var(--text-light);
    margin-top: 0.5rem;
  }

  .progress-percentage {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-weight: bold;
    color: white;
    text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
    font-size: 0.9rem;
    z-index: 2;
    width: 100%;
    text-align: center;
  }

  .goal-indicator {
    position: absolute;
    top: -25px;
    transform: translateX(-50%);
    background: var(--accent);
    color: white;
    padding: 0.3rem 0.6rem;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: bold;
    white-space: nowrap;
  }

  .goal-indicator::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border-left: 5px solid transparent;
    border-right: 5px solid transparent;
    border-top: 5px solid var(--accent);
  }

  .yearly-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 2rem;
  }

  .yearly-stat {
    background: var(--card-bg);
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: var(--shadow);
    text-align: center;
    transition: all 0.3s ease;
  }

  .yearly-stat:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-hover);
  }

  .yearly-stat h4 {
    font-size: 1rem;
    color: var(--text-light);
    margin-bottom: 0.5rem;
  }

  .yearly-stat .amount {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--secondary);
  }

  .yearly-stat.goal .amount {
    color: var(--warning) !important;
  }

  .yearly-stat.progress .amount {
    color: var(--success);
  }

  .percentage-cell {
    position: relative;
    min-width: 120px;
  }

  .percentage-bar-container {
    width: 100%;
    height: 20px;
    background-color: #34495e;
    border-radius: 10px;
    overflow: hidden;
    position: relative;
    margin-bottom: 5px;
  }

  .monthly-bar-1 { background-color: rgba(52, 152, 219, 0.95) !important; }
  .monthly-bar-2 { background-color: rgba(46, 204, 113, 0.95) !important; }
  .monthly-bar-3 { background-color: rgba(155, 89, 182, 0.95) !important; }
  .monthly-bar-4 { background-color: rgba(241, 196, 15, 0.95) !important; }
  .monthly-bar-5 { background-color: rgba(230, 126, 34, 0.95) !important; }
  .monthly-bar-6 { background-color: rgba(231, 76, 60, 0.95) !important; }
  .monthly-bar-7 { background-color: rgba(149, 165, 166, 0.95) !important; }
  .monthly-bar-8 { background-color: rgba(52, 73, 94, 0.95) !important; }
  .monthly-bar-9 { background-color: rgba(22, 160, 133, 0.95) !important; }
  .monthly-bar-10 { background-color: rgba(39, 174, 96, 0.95) !important; }
  .monthly-bar-11 { background-color: rgba(142, 68, 173, 0.95) !important; }
  .monthly-bar-12 { background-color: rgba(243, 156, 18, 0.95) !important; }

  .percentage-bar {
    height: 100%;
    border-radius: 10px;
    transition: width 0.5s ease;
    position: relative;
    /* stronger contrast and subtle gradient for better visibility */
    box-shadow: inset 0 -4px 8px rgba(0,0,0,0.35);
    background-image: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(0,0,0,0.08));
  }

  .percentage-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-weight: bold;
    color: white;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
    font-size: 0.9rem;
    z-index: 2;
    width: 100%;
    text-align: center;
  }

  /* Make the percentage indicator more visible when bar is small: add a thin border and contrasting overlay */
  .percentage-bar::after {
    content: '';
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: rgba(255,255,255,0.06);
    pointer-events: none;
  }

  /* Performance toggle buttons - more pronounced clickable buttons */
  .performance-toggle { display:flex; gap:0.6rem; margin:0.6rem 0; }
  .performance-btn {
    background: transparent;
    border: 1px solid rgba(255,255,255,0.06);
    color: var(--text);
    padding: 0.6rem 0.9rem;
    border-radius: 8px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.6rem;
    transition: all 0.18s ease;
    font-weight: 700;
    box-shadow: none;
  }
  .performance-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-hover); }
  .performance-btn.active {
    background: linear-gradient(90deg, var(--secondary), #2b79a8);
    border-color: transparent;
    color: white;
  }

  /* Make delete buttons clearly red where .btn-delete or .btn.btn-red are used */
  .btn.btn-red, .btn-delete, .delete-btn {
    background: linear-gradient(90deg, #e74c3c, #c0392b);
    color: white;
    border: none;
    box-shadow: 0 4px 14px rgba(231,76,60,0.25);
  }

  .percentage-value {
    display: none;
  }

  #members table td:last-child {
    white-space: nowrap;
  }

  #members table td:last-child .beneficiary-btn,
  #members table td:last-child .edit-btn,
  #members table td:last-child .delete-btn {
    margin: 2px;
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
  }

  #members table tr td:last-child {
    min-width: 280px;
  }

  .toast {
    position: fixed;
    top: 100px;
    right: 20px;
    padding: 1rem 1.5rem;
    background: var(--success);
    color: white;
    border-radius: 8px;
    box-shadow: var(--shadow-hover);
    z-index: 10000;
    transform: translateX(400px);
    transition: transform 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .toast.show {
    transform: translateX(0);
  }

  .toast.error {
    background: var(--accent);
  }

  .toast.warning {
    background: var(--warning);
  }

  .members-collect-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
    margin: 2rem 0;
  }
  
  .collect-card {
    background: var(--card-bg);
    padding: 2.5rem;
    border-radius: 16px;
    box-shadow: var(--shadow);
    transition: all 0.3s ease;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    border-left: 6px solid var(--secondary);
    text-align: left;
    height: 100%;
    min-height: 220px;
  }
  
  .collect-card:hover {
    transform: translateY(-8px);
    box-shadow: var(--shadow-hover);
    border-left: 6px solid var(--accent);
  }
  
  .collect-card h3 {
    color: var(--secondary);
    margin-bottom: 1.2rem;
    font-size: 1.6rem;
    display: flex;
    align-items: center;
    gap: 0.8rem;
  }
  
  .collect-card p {
    color: var(--text-light);
    line-height: 1.7;
    flex-grow: 1;
    font-size: 1.1rem;
  }
  
  .collect-icon {
    background: var(--secondary);
    color: white;
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1.2rem;
    font-size: 1.4rem;
  }
  
  .collect-card.warning {
    border-left: 6px solid var(--warning);
  }
  
  .collect-card.warning .collect-icon {
    background: var(--warning);
  }
  
  .collect-card.success {
    border-left: 6px solid var(--success);
  }
  
  .collect-card.success .collect-icon {
    background: var(--success);
  }

  .transport-tabs {
    display: flex;
    margin-bottom: 1.5rem;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }

  .transport-tab {
    padding: 0.8rem 1.5rem;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s ease;
    border-bottom: 3px solid transparent;
  }

  .transport-tab.active {
    color: var(--secondary);
    border-bottom: 3px solid var(--secondary);
  }

  .transport-tab:hover:not(.active) {
    background: rgba(52, 152, 219, 0.1);
  }

  .transport-tab-content {
    display: none;
  }

  .transport-tab-content.active {
    display: block;
  }

  /* Enhanced Attendance Styles */
  .attendance-controls {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    align-items: center;
    background: var(--card-bg);
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: var(--shadow);
  }

  .attendance-month-selector {
    display: flex;
    gap: 0.8rem;
    align-items: center;
    flex-wrap: wrap;
  }

  .date-picker-wrapper {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    font-size: 0.9rem;
    justify-content: center;
  }

  #attendanceDate {
    padding: 0.6rem 0.9rem;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.06);
    background: var(--card-bg);
    color: var(--text);
    box-shadow: var(--shadow);
    width: 140px; /* match save button width visually */
    min-height: 40px; /* match button height */
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  /* Ensure Save button matches height visually */
  #saveAttendance{min-height:40px;padding:.6rem .9rem}

  .month-year-group {
    display: flex;
    gap: 0.6rem;
    align-items: center;
  }

  .attendance-month-selector select {
    padding: 0.6rem 0.8rem;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.06);
    background: var(--primary);
    color: var(--text);
    box-shadow: var(--shadow);
    min-width: 120px;
  }

  .attendance-list {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: var(--shadow);
    margin-bottom: 2rem;
    max-height: 500px;
    overflow-y: auto;
  }

  .attendance-member {
    display: flex;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    transition: all 0.3s ease;
  }

  .attendance-member:hover {
    background: rgba(52, 152, 219, 0.05);
    transform: translateX(5px);
  }

  .attendance-member:last-child {
    border-bottom: none;
  }

  .attendance-member input[type="checkbox"] {
    margin-right: 1rem;
    transform: scale(1.3);
    accent-color: var(--success);
  }

  .attendance-member label {
    font-weight: 500;
    cursor: pointer;
    flex-grow: 1;
  }

  .attendance-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .attendance-stat {
    background: var(--card-bg);
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: var(--shadow);
    text-align: center;
    transition: all 0.3s ease;
  }

  .attendance-stat:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-hover);
  }

  .attendance-stat h4 {
    font-size: 1rem;
    color: var(--text-light);
    margin-bottom: 0.5rem;
  }

  /* Highlight attendance rate in green */
  .attendance-rate-value {
    background: linear-gradient(90deg, rgba(39,174,96,0.12), rgba(46,204,113,0.12));
    color: var(--success);
    font-weight: 800;
    padding: 0.4rem 0.6rem;
    border-radius: 8px;
    display: inline-block;
    min-width: 64px;
    text-align: center;
    box-shadow: inset 0 -2px 6px rgba(0,0,0,0.08);
  }

  .attendance-stat .value {
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--secondary);
  }

  .attendance-stat.present .value {
    color: var(--success);
  }

  .attendance-stat.absent .value {
    color: var(--accent);
  }

  .attendance-stat.rate .value {
    color: var(--warning);
  }

  /* Payment Search */
  .payment-search-container {
    margin-bottom: 1.5rem;
  }

  #paymentSearch {
    width: 100%;
    max-width: 400px;
    padding: 0.8rem 1.2rem;
    font-size: 1rem;
    border: 1px solid #555;
    border-radius: 8px;
    background: var(--card-bg);
    color: var(--text);
  }

  /* Transport Breakdown */
  .breakdown-section {
    background: var(--card-bg);
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: var(--shadow);
    margin-bottom: 2rem;
  }

  .breakdown-section h3 {
    color: var(--secondary);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  /* Enhanced Members Performance Styles */
  .performance-toggle {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    background: var(--card-bg);
    padding: 1.5rem;
    border-radius: 16px;
    box-shadow: var(--shadow);
    justify-content: center;
  }

  .performance-btn {
    padding: 1.2rem 2rem;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 700;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.8rem;
    flex: 1;
    justify-content: center;
    max-width: 400px;
    font-size: 1.2rem;
    box-shadow: var(--shadow);
    position: relative;
    overflow: hidden;
  }

  .performance-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: all 0.5s ease;
  }

  .performance-btn:hover::before {
    left: 100%;
  }

  .performance-btn.active {
    background: var(--secondary);
    color: white;
    transform: translateY(-5px);
    box-shadow: var(--shadow-hover);
  }

  .performance-btn:not(.active) {
    background: var(--primary);
    color: var(--text);
  }

  .performance-btn:not(.active):hover {
    background: #1e2a38;
    transform: translateY(-3px);
  }

  .performance-view-container {
    display: none;
  }

  .performance-view-container.active {
    display: block;
  }

  .member-performance-card {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    box-shadow: var(--shadow);
    border-left: 4px solid var(--secondary);
    transition: all 0.3s ease;
    position: relative;
  }

  .member-performance-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-hover);
  }

  .member-performance-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .member-performance-name {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--secondary);
  }

  .member-performance-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
  }

  .performance-stat {
    text-align: center;
  }

  .performance-stat .label {
    font-size: 0.9rem;
    color: var(--text-light);
    margin-bottom: 0.3rem;
  }

  .performance-stat .value {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--text);
  }

  .performance-stat.payments .value {
    color: var(--success);
  }

  .performance-stat.fines .value {
    color: var(--warning);
  }

  .performance-stat.attendance .value {
    color: var(--secondary);
  }

  /* NEW: Enhanced Member Performance Styles */
  .member-goal-indicator {
    position: absolute;
    bottom: 10px;
    left: 10px;
    font-size: 0.8rem;
    color: var(--text-light);
    background: rgba(255, 255, 255, 0.1);
    padding: 0.3rem 0.6rem;
    border-radius: 4px;
    display: flex;
    align-items: center;
    gap: 0.3rem;
  }

  .yearly-view-search {
    margin-bottom: 1.5rem;
  }

  #yearlyMemberSearch {
    width: 100%;
    max-width: 400px;
    padding: 0.8rem 1.2rem;
    font-size: 1rem;
    border: 1px solid #555;
    border-radius: 8px;
    background: var(--card-bg);
    color: var(--text);
  }

  /* Attendance Breakdown Styles */
  .attendance-breakdown {
    margin-top: 2rem;
  }

  .attendance-breakdown-tabs {
    display: flex;
    margin-bottom: 1.5rem;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }

  .attendance-breakdown-tab {
    padding: 0.8rem 1.5rem;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s ease;
    border-bottom: 3px solid transparent;
  }

  .attendance-breakdown-tab.active {
    color: var(--secondary);
    border-bottom: 3px solid var(--secondary);
  }

  .attendance-breakdown-tab:hover:not(.active) {
    background: rgba(52, 152, 219, 0.1);
  }

  .attendance-breakdown-content {
    display: none;
  }

  .attendance-breakdown-content.active {
    display: block;
  }

  .attendance-member-present {
    border-left: 4px solid var(--success);
  }

  .attendance-member-absent {
    border-left: 4px solid var(--accent);
  }

  /* NEW: Added search box for attendance */
  .attendance-search-container {
    margin-bottom: 1.5rem;
  }

  #attendanceSearch {
    width: 100%;
    max-width: 400px;
    padding: 0.8rem 1.2rem;
    font-size: 1rem;
    border: 1px solid #555;
    border-radius: 8px;
    background: var(--card-bg);
    color: var(--text);
  }

  /* NEW: Enhanced Organizational Performance Styles */
  .organizational-performance-container {
    background: var(--card-bg);
    border-radius: 16px;
    padding: 2rem;
    box-shadow: var(--shadow);
    margin-bottom: 2rem;
  }

  .organizational-performance-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }

  .organizational-performance-header h3 {
    color: var(--secondary);
    font-size: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.8rem;
  }

  .monthly-goal-container {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .monthly-goal-container h4 {
    color: var(--text-light);
    margin-bottom: 1rem;
    font-size: 1.1rem;
  }

  .monthly-breakdown-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
  }

  .monthly-breakdown-card {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.3s ease;
  }

  .monthly-breakdown-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow);
  }

  .monthly-breakdown-card h5 {
    color: var(--secondary);
    margin-bottom: 0.5rem;
    font-size: 1.1rem;
  }

  .monthly-breakdown-card .amount {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text);
  }

  .monthly-breakdown-card .percentage {
    font-size: 0.9rem;
    color: var(--text-light);
    margin-top: 0.5rem;
  }

  @media (max-width: 980px){
    .container {
      grid-template-columns: 1fr;
      padding: 2rem 1rem;
    }
    
    nav {
      flex-direction: column;
      padding: 1rem;
      gap: 1rem;
    }
    
    nav ul {
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .form-search-container {
      flex-direction: column;
    }
    
    #memberForm {
      flex: 1;
    }
    
    #memberSearch {
      max-width: 100%;
    }
    
    .hero h2 {
      font-size: 2.2rem;
    }
    
    .section-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }
    
    .export-buttons {
      width: 100%;
      justify-content: flex-start;
    }

    .reports-actions {
      grid-template-columns: 1fr;
    }
    
    .report-actions,
    .quick-actions,
    .statement-actions {
      flex-wrap: nowrap;
      overflow-x: auto;
      padding-bottom: 1rem;
    }
    
    .quick-action-btn {
      flex-shrink: 0;
    }
    
    .members-collect-cards {
      grid-template-columns: 1fr;
    }

    .performance-toggle {
      flex-direction: column;
      align-items: center;
    }

    .performance-btn {
      max-width: 100%;
      padding: 1rem 1.5rem;
      font-size: 1.1rem;
    }
  }

  @media (max-width: 768px) {
    .content {
      padding: 1.5rem;
    }
    
    .modal-content {
      width: 95%;
      padding: 1.5rem;
    }
    
    .modal-buttons {
      flex-direction: column;
    }
    
    .btn {
      width: 100%;
      justify-content: center;
    }
    
    .export-buttons {
      flex-direction: column;
    }
    
    .summary-cards {
      grid-template-columns: 1fr;
    }
    
    .summary-card.total {
      text-align: center;
      padding-right: 1.5rem;
    }
    
    .content table {
      display: block;
      overflow-x: auto;
      white-space: nowrap;
    }
    
    #payments table td:nth-child(4) {
      white-space: nowrap;
    }
    
    .report-actions,
    .quick-actions,
    .statement-actions {
      flex-wrap: nowrap;
      overflow-x: auto;
    }

    .member-performance-stats {
      grid-template-columns: 1fr 1fr;
    }

    .attendance-breakdown-tabs {
      flex-direction: column;
    }

    .attendance-breakdown-tab {
      text-align: center;
    }

    .monthly-breakdown-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
<link rel="stylesheet" href="styles/ui-theme.css">
</head>
<body class="dark">
<div class="app-container">
  <nav>
    <div class="logo-container" id="logoContainer">
      <img src="file_0000000038d461f8aa257e1fadde4cda.jpeg" alt="TSHILAPFENE BURIAL SOCIETY Logo" class="logo" id="logo">
    </div>
    <ul>
      <li><a href="#" data-section="home"><i class="fas fa-home"></i> Home</a></li>
      <li><a href="#" data-section="members"><i class="fas fa-users"></i> Members</a></li>
      <li><a href="#" data-section="attendance"><i class="fas fa-calendar-check"></i> Attendance</a></li>
      <li><a href="#" data-section="payments"><i class="fas fa-money-bill-wave"></i> Payments</a></li>
      <li><a href="#" data-section="reports"><i class="fas fa-chart-bar"></i> Reports</a></li>
    </ul>
  </nav>

  <section class="hero" id="homeSection">
    <div class="hero-content">
      <h2>Dignified Support in Times of Need</h2>
      <p>Comprehensive management for members, payments, and beneficiaries</p>
    </div>
  </section>

  <div class="container" id="homeCards">
    <div class="card" data-section="members">
      <div class="card-icon"><i class="fas fa-user-friends"></i></div>
      <h3>Member Management</h3>
      <p>Register members, upload IDs, and manage profiles with our intuitive system.</p>
    </div>
    <div class="card" data-section="payments">
      <div class="card-icon"><i class="fas fa-credit-card"></i></div>
      <h3>Payment Tracking</h3>
      <p>Track fees, contributions, and allocate payments with detailed reporting.</p>
    </div>
    <div class="card" data-section="attendance">
      <div class="card-icon"><i class="fas fa-calendar-check"></i></div>
      <h3>Attendance Tracking</h3>
      <p>Record and monitor member attendance for meetings and events.</p>
    </div>
    <div class="card" data-section="reports">
      <div class="card-icon"><i class="fas fa-chart-pie"></i></div>
      <h3>Reporting</h3>
      <p>Generate detailed financial and membership reports with visual analytics.</p>
    </div>
  </div>

  <div class="content" id="members">
    <button class="back-button" id="backToHomeFromMembers">
      <i class="fas fa-arrow-left"></i> Back to Home
    </button>
    <div class="section-header">
      <h2><i class="fas fa-users"></i> Members Management</h2>
      <div class="export-buttons">
        <button class="export-btn" id="exportPDF">
          <i class="fas fa-file-pdf"></i> Export PDF
        </button>
        <button class="export-btn" id="exportExcel">
          <i class="fas fa-file-excel"></i> Export Excel
        </button>
      </div>
    </div>
    <p class="small-muted">Register new members and manage their beneficiaries with ease.</p>
    
    <div class="form-search-container">
      <form id="memberForm">
        <input type="text" id="memberNumber" placeholder="Member Number">
        <input type="text" id="name" placeholder="Full Name" required>
        <input type="text" id="idNumber" placeholder="ID Number" required>
        <input type="text" id="phone" placeholder="Phone Number" required>

        <button type="submit" id="memberSubmit" class="add-btn-green">
          <i class="fas fa-plus"></i> Add Member
        </button>
      </form>

      <input type="text" id="memberSearch" placeholder="Search by name or member number...">
    </div>

    <table>
      <thead>
        <tr>
          <th>Member Number</th>
          <th>Full Name</th>
          <th>ID Number</th>
          <th>Phone</th>
          <th>Beneficiaries</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="memberList"></tbody>
    </table>
  </div>

  <div class="content" id="payments">
    <button class="back-button" id="backToHomeFromPayments">
      <i class="fas fa-arrow-left"></i> Back to Home
    </button>
    <div class="section-header">
      <h2><i class="fas fa-money-bill-wave"></i> Payment Management</h2>
      <div class="export-buttons">
        <button class="export-btn" id="exportPaymentsPDF">
          <i class="fas fa-file-pdf"></i> Export PDF
        </button>
        <button class="export-btn" id="exportPaymentsExcel">
          <i class="fas fa-file-excel"></i> Export Excel
        </button>
      </div>
    </div>
    <p class="small-muted">Record and track member payments, fines, and other contributions.</p>
    
    <div class="payment-search-container">
      <input type="text" id="paymentSearch" placeholder="Search payments by member name...">
    </div>
    
    <div class="summary-cards">
      <div class="summary-card" id="monthlyCollectionsCard">
        <h3>Monthly Collections</h3>
        <div class="amount" id="monthlyCollections">R0.00</div>
      </div>
      <div class="summary-card" id="finesCollectedCard">
        <h3>Fines Collected</h3>
        <div class="amount" id="finesCollected">R0.00</div>
      </div>
      <div class="summary-card" id="transportMoneyCard">
        <h3>Transport Money</h3>
        <div class="amount" id="transportMoney">R0.00</div>
      </div>
      <div class="summary-card total" id="totalCollectedCard">
        <h3>Total Collected</h3>
        <div class="amount" id="totalCollected">R0.00</div>
      </div>
    </div>
    
    <div class="expandable-section" id="paymentDetailsSection">
      <div class="expandable-header">
        <h3><i class="fas fa-receipt"></i> Payment Details</h3>
        <i class="fas fa-chevron-down expand-icon"></i>
      </div>
      <div class="expandable-content">
        <div class="expandable-content-inner">
          <form id="paymentForm">
            <select id="paymentMember" required>
              <option value="">Select Member</option>
            </select>
            <input type="date" id="paymentDate" required>
            <input type="number" id="monthlyCollection" placeholder="Monthly Collection" step="0.01">
            <select id="dressCode">
              <option value="">Select Dress Code</option>
              <option value="Jacket">Jacket</option>
              <option value="Shirt">Shirt</option>
              <option value="Other">Other</option>
            </select>
            <select id="fineType">
              <option value="">Select Fine Type</option>
              <option value="Late Coming">Late Coming</option>
              <option value="Swearing">Swearing</option>
              <option value="Absence">Absence</option>
              <option value="Misconduct">Misconduct</option>
              <option value="Other">Other</option>
            </select>
            <input type="number" id="fineAmount" placeholder="Fine Amount (leave empty for due)" step="0.01">
            <div class="custom-select">
              <select id="transport">
                <option value="">Select Transport Payment</option>
                <option value="20">R20 Transport Fee</option>
              </select>
            </div>
            <input type="text" id="funeralFor" placeholder="Funeral For (Name of deceased)" style="display: none;">
            <button type="button" id="transportPaymentBtn" class="btn btn-primary">
              <i class="fas fa-bus"></i> Add Transport Payment
            </button>
            <button type="submit" class="btn btn-green">
              <i class="fas fa-plus"></i> Add Payment
            </button>
          </form>
          
          <table>
            <thead>
              <tr>
                <th>Book No</th>
                <th>Name</th>
                <th>Surname</th>
                <th>Date</th>
                <th>Monthly Collections</th>
                <th>Dress Code</th>
                <th>Fines</th>
                <th>Transport</th>
                <th>Total Payment</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="paymentList"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="content" id="attendance">
    <button class="back-button" id="backToHomeFromAttendance">
      <i class="fas fa-arrow-left"></i> Back to Home
    </button>
    <div class="section-header">
      <h2><i class="fas fa-calendar-check"></i> Attendance Tracking</h2>
      <div class="export-buttons">
        <button class="export-btn" id="exportAttendancePDF">
          <i class="fas fa-file-pdf"></i> Export PDF
        </button>
        <button class="export-btn" id="exportAttendanceExcel">
          <i class="fas fa-file-excel"></i> Export Excel
        </button>
      </div>
    </div>
    <p class="small-muted">Record and track member attendance for meetings and events.</p>
    
    <!-- NEW: Added search box for attendance -->
    <div class="attendance-search-container">
      <input type="text" id="attendanceSearch" placeholder="Search members by name or member number...">
    </div>
    
    <div class="attendance-controls">
      <div class="attendance-month-selector">
        <!-- Modern date picker (optional). If empty, code will default to today -->
        <div class="date-picker-wrapper">
          <label for="attendanceDate" class="small-muted">Date (optional)</label>
          <input type="date" id="attendanceDate" />
        </div>

        <!-- Month/Year selects removed: use the date picker above -->

        <button class="btn btn-primary" id="saveAttendance">
          <i class="fas fa-save"></i> Save Attendance
        </button>
      </div>
    </div>
    
    <div class="attendance-stats">
      <div class="attendance-stat present">
        <h4>Present Today</h4>
        <div class="value" id="presentCount">0</div>
      </div>
      <div class="attendance-stat absent">
        <h4>Absent Today</h4>
        <div class="value" id="absentCount">0</div>
      </div>
      <div class="attendance-stat rate">
        <h4>Attendance Rate</h4>
        <div class="value attendance-rate-value" id="attendanceRate">0%</div>
      </div>
      <div class="attendance-stat">
        <h4>Total Members</h4>
        <div class="value" id="totalMembersCount">0</div>
      </div>
    </div>
    
    <div class="attendance-list" id="attendanceList">
      <!-- Attendance list will be populated by JavaScript -->
    </div>
  </div>

  <div class="content" id="reports">
    <button class="back-button" id="backToHomeFromReports">
      <i class="fas fa-arrow-left"></i> Back to Home
    </button>
    <div class="section-header">
      <h2><i class="fas fa-chart-bar"></i> Reports</h2>
      <div class="export-buttons">
        <button class="export-btn" id="exportReportsPDF">
          <i class="fas fa-file-pdf"></i> Export PDF
        </button>
        <button class="export-btn" id="exportReportsExcel">
          <i class="fas fa-file-excel"></i> Export Excel
        </button>
      </div>
    </div>
    <p class="small-muted">Generate summaries of income, expenses, and membership statistics.</p>
    
    <div class="reports-grid" id="reportsDashboard">
      <div class="report-card" data-report="statements">
        <div class="report-icon">
          <i class="fas fa-file-invoice-dollar"></i>
        </div>
        <h3>Members Collect</h3>
        <p>View detailed payment statements and collection reports for all members with comprehensive breakdowns.</p>
        <div class="report-card-arrow">
          <i class="fas fa-arrow-right"></i>
        </div>
      </div>
      
      <div class="report-card warning" data-report="fines">
        <div class="report-icon">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h3>Fines Management</h3>
        <p>Manage and track fines for member violations and late payments with detailed statements.</p>
        <div class="report-card-arrow">
          <i class="fas fa-arrow-right"></i>
        </div>
      </div>
      
      <div class="report-card" data-report="redflags">
        <div class="report-icon">
          <i class="fas fa-flag"></i>
        </div>
        <h3>Red Flagged Membership</h3>
        <p>Identify members who haven't made monthly payments in over 6 months and require immediate attention.</p>
        <div class="report-card-arrow">
          <i class="fas fa-arrow-right"></i>
        </div>
      </div>
      
      <div class="report-card danger" data-report="transport">
        <div class="report-icon">
          <i class="fas fa-bus"></i>
        </div>
        <h3>Transport Collection Due</h3>
        <p>Manage and track funeral transport collections with automated payment tracking.</p>
        <div class="report-card-arrow">
          <i class="fas fa-arrow-right"></i>
        </div>
      </div>
      
      <div class="report-card success" data-report="attendance">
        <div class="report-icon">
          <i class="fas fa-calendar-check"></i>
        </div>
        <h3>Attendance Records</h3>
        <p>View and analyze member attendance patterns and generate attendance reports.</p>
        <div class="report-card-arrow">
          <i class="fas fa-arrow-right"></i>
        </div>
      </div>
    </div>

    <!-- Updated Members Collect Section -->
    <div class="report-content" id="statementsReport">
      <button class="back-button" id="backToReportsFromStatements">
        <i class="fas fa-arrow-left"></i> Back to Reports
      </button>
      <div class="report-header">
        <h2><i class="fas fa-file-invoice-dollar"></i> Members Collect</h2>
        <div class="export-buttons">
          <button class="export-btn" id="exportStatementsPDF">
            <i class="fas fa-file-pdf"></i> Export PDF
          </button>
          <button class="export-btn" id="exportStatementsExcel">
            <i class="fas fa-file-excel"></i> Export Excel
          </button>
        </div>
      </div>

      <div class="members-collect-cards">
        <div class="collect-card" id="monthlyCollectionsView">
          <div class="collect-icon">
            <i class="fas fa-calendar-alt"></i>
          </div>
          <h3>Monthly Collections</h3>
          <p>View detailed monthly payment collections with breakdown by member and payment type.</p>
        </div>
        
        <div class="collect-card success" id="yearlyView">
          <div class="collect-icon">
            <i class="fas fa-chart-line"></i>
          </div>
          <h3>Yearly View</h3>
          <p>Analyze yearly payment trends and performance with comprehensive visual reports.</p>
        </div>
      </div>

      <div id="statementsContainer"></div>
    </div>

    <!-- New Monthly Collections Page -->
    <div class="report-content" id="monthlyCollectionsPage">
      <button class="back-button" id="backToStatementsFromMonthly">
        <i class="fas fa-arrow-left"></i> Back to Members Collect
      </button>
      <div class="report-header">
        <h2><i class="fas fa-calendar-alt"></i> Monthly Collections</h2>
        <div class="export-buttons">
          <button class="export-btn" id="exportMonthlyPDF">
            <i class="fas fa-file-pdf"></i> Export PDF
          </button>
          <button class="export-btn" id="exportMonthlyExcel">
            <i class="fas fa-file-excel"></i> Export Excel
          </button>
        </div>
      </div>

      <div id="monthlyCollectionsContainer"></div>
    </div>

    <!-- New Yearly View Page -->
    <div class="report-content" id="yearlyViewPage">
      <button class="back-button" id="backToStatementsFromYearly">
        <i class="fas fa-arrow-left"></i> Back to Members Collect
      </button>
      <div class="report-header">
        <h2><i class="fas fa-chart-line"></i> Yearly View</h2>
        <div class="export-buttons">
          <button class="export-btn" id="exportYearlyPDF">
            <i class="fas fa-file-pdf"></i> Export PDF
          </button>
          <button class="export-btn" id="exportYearlyExcel">
            <i class="fas fa-file-excel"></i> Export Excel
          </button>
        </div>
      </div>

      <div id="yearlyViewContainer"></div>
    </div>

    <div class="report-content" id="finesReport">
      <button class="back-button" id="backToReportsFromFines">
        <i class="fas fa-arrow-left"></i> Back to Reports
      </button>
      <div class="report-header">
        <h2><i class="fas fa-exclamation-triangle"></i> Fines Management</h2>
        <div class="export-buttons">
          <button class="export-btn" id="exportFinesPDF">
            <i class="fas fa-file-pdf"></i> Export PDF
          </button>
          <button class="export-btn" id="exportFinesExcel">
            <i class="fas fa-file-excel"></i> Export Excel
          </button>
        </div>
      </div>

      <div class="report-actions">
        <button class="quick-action-btn warning" id="generateFinesReport">
          <i class="fas fa-sync"></i> Generate Fines Report
        </button>
      </div>

      <div id="finesContainer"></div>
    </div>

    <div class="report-content" id="redflagsReport">
      <button class="back-button" id="backToReportsFromRedflags">
        <i class="fas fa-arrow-left"></i> Back to Reports
      </button>
      <div class="report-header">
        <h2><i class="fas fa-flag"></i> Red Flagged Membership</h2>
        <div class="export-buttons">
          <button class="export-btn" id="exportRedflagsPDF">
            <i class="fas fa-file-pdf"></i> Export PDF
          </button>
          <button class="export-btn" id="exportRedflagsExcel">
            <i class="fas fa-file-excel"></i> Export Excel
          </button>
        </div>
      </div>

      <div class="report-actions">
        <button class="quick-action-btn warning" id="generateRedFlagReport">
          <i class="fas fa-flag"></i> Generate Red Flag Report
        </button>
      </div>

      <div id="redFlagContainer"></div>
    </div>

    <div class="report-content" id="transportReport">
      <button class="back-button" id="backToReportsFromTransport">
        <i class="fas fa-arrow-left"></i> Back to Reports
      </button>
      <div class="report-header">
        <h2><i class="fas fa-bus"></i> Transport Collection Due</h2>
        <div class="export-buttons">
          <button class="export-btn" id="exportTransportPDF">
            <i class="fas fa-file-pdf"></i> Export PDF
          </button>
          <button class="export-btn" id="exportTransportExcel">
            <i class="fas fa-file-excel"></i> Export Excel
          </button>
        </div>
      </div>

      <div class="report-actions">
        <button class="quick-action-btn success" id="chargeTransportFee">
          <i class="fas fa-plus-circle"></i> Charge R20 Transport Fee to All
        </button>
        <button class="quick-action-btn warning" id="generateTransportReport">
          <i class="fas fa-sync"></i> Refresh Transport Report
        </button>
        <button class="quick-action-btn primary" id="transportBreakdown">
          <i class="fas fa-chart-pie"></i> Transport Breakdown
        </button>
      </div>

      <div class="transport-tabs">
        <div class="transport-tab active" data-tab="due">Due Payments</div>
        <div class="transport-tab" data-tab="paid">Paid Payments</div>
      </div>

      <div class="transport-tab-content active" id="transportDueTab">
        <div id="transportDueContainer"></div>
      </div>

      <div class="transport-tab-content" id="transportPaidTab">
        <div id="transportPaidContainer"></div>
      </div>
      
      <div id="transportBreakdownContainer"></div>
    </div>

    <div class="report-content" id="attendanceReport">
      <button class="back-button" id="backToReportsFromAttendance">
        <i class="fas fa-arrow-left"></i> Back to Reports
      </button>
      <div class="report-header">
        <h2><i class="fas fa-calendar-check"></i> Attendance Records</h2>
        <div class="export-buttons">
          <button class="export-btn" id="exportAttendanceReportPDF">
            <i class="fas fa-file-pdf"></i> Export PDF
          </button>
          <button class="export-btn" id="exportAttendanceReportExcel">
            <i class="fas fa-file-excel"></i> Export Excel
          </button>
        </div>
      </div>

      <div class="report-actions">
        <button class="quick-action-btn primary" id="generateAttendanceReport">
          <i class="fas fa-sync"></i> Generate Attendance Report
        </button>
      </div>

      <div id="attendanceReportContainer"></div>
    </div>
    
  </div>

  <!-- All modals remain the same as in original code -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <h3><i class="fas fa-exclamation-circle"></i> Confirm Deletion</h3>
      <p>Are you sure you want to delete this member? This action cannot be undone.</p>
      <div class="modal-buttons">
        <button id="confirmDelete" class="btn btn-red"><i class="fas fa-check"></i> Yes, Delete</button>
        <button id="cancelDelete" class="btn btn-ghost"><i class="fas fa-times"></i> Cancel</button>
      </div>
    </div>
  </div>

  <div id="editChoiceModal" class="modal">
    <div class="modal-content">
      <h3><i class="fas fa-edit"></i> Edit Options</h3>
      <p>What would you like to edit for this member?</p>
      <div class="modal-buttons">
        <button id="choiceEditMember" class="btn btn-orange"><i class="fas fa-user-edit"></i> Edit Member</button>
        <button id="choiceEditBen" class="btn btn-green"><i class="fas fa-users"></i> Edit Beneficiaries</button>
        <button id="choiceCancel" class="btn btn-ghost"><i class="fas fa-times"></i> Cancel</button>
      </div>
    </div>
  </div>

  <div id="addBenModal" class="modal">
    <div class="modal-content">
      <h3><i class="fas fa-user-plus"></i> Add Beneficiary</h3>
      <div id="addBenContainer" style="display:flex;flex-direction:column;gap:0.8rem;margin-top:1rem;">
        <input type="text" id="beneficiaryName" placeholder="Beneficiary Full Name" class="modal-input">
        <input type="text" id="beneficiaryId" placeholder="Beneficiary ID Number" class="modal-input">
        <input type="text" id="beneficiaryRelationship" placeholder="Relationship to Member" class="modal-input">
      </div>
      <div style="display:flex;gap:0.8rem;justify-content:center;margin-top:1.5rem;">
        <button id="addBenSave" class="btn btn-green"><i class="fas fa-save"></i> Add Beneficiary</button>
        <button id="addBenCancel" class="btn btn-ghost"><i class="fas fa-times"></i> Cancel</button>
      </div>
    </div>
  </div>

  <div id="editBenModal" class="modal">
    <div class="modal-content">
      <h3><i class="fas fa-users"></i> Edit Beneficiaries</h3>
      <div id="modalBenContainer" style="display:flex;flex-direction:column;gap:0.8rem;margin-top:1rem;"></div>
      <div style="display:flex;gap:0.8rem;justify-content:center;margin-top:1.5rem;">
        <button id="modalAddRow" class="btn btn-primary"><i class="fas fa-plus"></i> Add Row</button>
        <button id="modalSaveBen" class="btn btn-green"><i class="fas fa-save"></i> Save Changes</button>
        <button id="modalCancelBen" class="btn btn-ghost"><i class="fas fa-times"></i> Cancel</button>
      </div>
    </div>
  </div>

  <div id="paymentEditModal" class="modal">
    <div class="modal-content">
      <h3><i class="fas fa-edit"></i> Edit Payment</h3>
      <form id="editPaymentForm" style="display:flex;flex-direction:column;gap:1rem;margin-top:1.5rem;">
        <input type="date" id="editPaymentDate" required class="modal-input">
        <input type="number" id="editMonthlyCollection" placeholder="Monthly Collection" step="0.01" class="modal-input">
        <select id="editDressCode" class="modal-input">
          <option value="">Select Dress Code</option>
          <option value="Jacket">Jacket</option>
          <option value="Shirt">Shirt</option>
          <option value="Other">Other</option>
        </select>
        <select id="editFineType" class="modal-input">
          <option value="">Select Fine Type</option>
          <option value="Late Coming">Late Coming</option>
          <option value="Swearing">Swearing</option>
          <option value="Absence">Absence</option>
          <option value="Misconduct">Misconduct</option>
          <option value="Other">Other</option>
        </select>
        <input type="number" id="editFineAmount" placeholder="Fine Amount (leave empty for due)" step="0.01" class="modal-input">
        <div class="custom-select">
          <select id="editTransport" class="modal-input">
            <option value="">Select Transport Payment</option>
            <option value="20">R20 Transport Fee</option>
          </select>
        </div>
        <input type="text" id="editFuneralFor" placeholder="Funeral For (Name of deceased)" style="display: none;" class="modal-input">
      </form>
      <div class="modal-buttons">
        <button id="savePaymentEdit" class="btn btn-green"><i class="fas fa-save"></i> Save Changes</button>
        <button id="cancelPaymentEdit" class="btn btn-ghost"><i class="fas fa-times"></i> Cancel</button>
      </div>
    </div>
  </div>

  <div id="paymentDeleteModal" class="modal">
    <div class="modal-content">
      <h3><i class="fas fa-exclamation-circle"></i> Confirm Payment Deletion</h3>
      <p>Are you sure you want to delete this payment? This action cannot be undone.</p>
      <div class="modal-buttons">
        <button id="confirmPaymentDelete" class="btn btn-red"><i class="fas fa-check"></i> Yes, Delete</button>
        <button id="cancelPaymentDelete" class="btn btn-ghost"><i class="fas fa-times"></i> Cancel</button>
      </div>
    </div>
  </div>

  <div id="editMemberModal" class="modal">
    <div class="modal-content">
      <h3><i class="fas fa-user-edit"></i> Edit Member</h3>
      <form id="editMemberForm" style="display:flex;flex-direction:column;gap:1rem;margin-top:1.5rem;">
        <input type="text" id="editMemberNumber" placeholder="Member Number" class="modal-input">
        <input type="text" id="editName" placeholder="Full Name" required class="modal-input">
        <input type="text" id="editIdNumber" placeholder="ID Number" required class="modal-input">
        <input type="text" id="editPhone" placeholder="Phone Number" required class="modal-input">
      </form>
      <div class="modal-buttons">
        <button id="saveMemberEdit" class="btn btn-green"><i class="fas fa-save"></i> Save Changes</button>
        <button id="cancelMemberEdit" class="btn btn-ghost"><i class="fas fa-times"></i> Cancel</button>
      </div>
    </div>
  </div>

  <footer>
    <p>Impowered By Lifhasi Technologies.</p>
  </footer>
</div>

<div id="toast" class="toast"></div>

<script>
// DOM Elements and Data
const navLinks = document.querySelectorAll("nav ul li a, .card");
const sections = document.querySelectorAll(".content");
const homeHero = document.getElementById("homeSection");
const homeCards = document.getElementById("homeCards");
const memberForm = document.getElementById("memberForm");
const memberList = document.getElementById("memberList");
const searchInput = document.getElementById("memberSearch");
const memberSubmit = document.getElementById("memberSubmit");
const paymentForm = document.getElementById("paymentForm");
const paymentList = document.getElementById("paymentList");
const paymentMemberSelect = document.getElementById("paymentMember");
const exportPaymentsExcelBtn = document.getElementById("exportPaymentsExcel");
const exportExcelBtn = document.getElementById("exportExcel");
const toast = document.getElementById("toast");
const transportPaymentBtn = document.getElementById("transportPaymentBtn");
const funeralForInput = document.getElementById("funeralFor");
const paymentSearch = document.getElementById("paymentSearch");

// NEW: Elements for new features
const monthlyCollectionsView = document.getElementById("monthlyCollectionsView");
const yearlyView = document.getElementById("yearlyView");
const chargeTransportFeeBtn = document.getElementById("chargeTransportFee");
const generateTransportReportBtn = document.getElementById("generateTransportReport");
const generateRedFlagReportBtn = document.getElementById("generateRedFlagReport");
const transportBreakdownBtn = document.getElementById("transportBreakdown");

// Attendance Elements (date-driven)
const attendanceDateInput = document.getElementById('attendanceDate');
const saveAttendanceBtn = document.getElementById("saveAttendance");
const attendanceList = document.getElementById("attendanceList");
const totalMembersCount = document.getElementById("totalMembersCount");
const presentCount = document.getElementById("presentCount");
const absentCount = document.getElementById("absentCount");
const attendanceRate = document.getElementById("attendanceRate");

// NEW: Attendance search element
const attendanceSearch = document.getElementById("attendanceSearch");

// Data
let members = JSON.parse(localStorage.getItem("members")) || [];
let payments = JSON.parse(localStorage.getItem("payments")) || [];
let attendance = JSON.parse(localStorage.getItem("attendance")) || {};
let editIndex = -1;
let deleteIndex = null;
let currentMemberIndex = null;
let editPaymentIndex = null;
let deletePaymentIndex = null;

// Initialize with sample data if empty
if (members.length === 0) {
  members = [
    { memberNumber: "001", name: "John Doe", idNumber: "8501011234081", phone: "0712345678", beneficiaries: [] },
    { memberNumber: "002", name: "Jane Smith", idNumber: "9002155678082", phone: "0723456789", beneficiaries: [] },
    { memberNumber: "003", name: "Robert Brown", idNumber: "8803057890083", phone: "0734567890", beneficiaries: [] }
  ];
  saveMembers();
}

if (payments.length === 0) {
  payments = [
    { bookNo: 1, name: "John", surname: "Doe", date: "2025-01-15", monthlyCollection: 100, dressCode: "Jacket", fines: "Late Coming (R30.00) - Paid", transport: 20, totalPayment: 900, funeralFor: "" },
    { bookNo: 2, name: "Jane", surname: "Smith", date: "2025-01-16", monthlyCollection: 100, dressCode: "Shirt", fines: "Swearing - Due", transport: 20, totalPayment: 620, funeralFor: "" },
    { bookNo: 3, name: "Robert", surname: "Brown", date: "2025-01-17", monthlyCollection: 100, dressCode: "", fines: "Absence (R50.00) - Paid", transport: 0, totalPayment: 150, funeralFor: "" }
  ];
  savePayments();
}

// Helper Functions
function showToast(message, type = 'success') {
  toast.textContent = message;
  toast.className = `toast ${type} show`;
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

function escHtml(str=''){ 
  return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); 
}

function saveMembers(){ 
  // Sort members by member number before saving
  members.sort((a, b) => {
    const numA = parseInt(a.memberNumber) || 0;
    const numB = parseInt(b.memberNumber) || 0;
    return numA - numB;
  });
  localStorage.setItem('members', JSON.stringify(members)); 
}

function savePayments(){ 
  localStorage.setItem('payments', JSON.stringify(payments)); 
}

function saveAttendance() {
  localStorage.setItem('attendance', JSON.stringify(attendance));
}

function formatCurrency(amount) {
  return 'R' + parseFloat(amount || 0).toFixed(2);
}

function calculateTotalPayment(payment) {
  let total = 0;
  total += parseFloat(payment.monthlyCollection || 0);
  total += parseFloat(payment.transport || 0);
  
  if (payment.dressCode === 'Jacket') total += 750;
  else if (payment.dressCode === 'Shirt') total += 500;
  
  // Extract fine amount if present
  if (payment.fines && payment.fines.includes('(R')) {
    const fineMatch = payment.fines.match(/\(R([0-9.]+)\)/);
    if (fineMatch) {
      total += parseFloat(fineMatch[1]);
    }
  }
  
  return total;
}

function generateMemberNumber() {
  const maxNumber = members.reduce((max, member) => {
    const num = parseInt(member.memberNumber) || 0;
    return num > max ? num : max;
  }, 0);
  return (maxNumber + 1).toString().padStart(3, '0');
}

function extractAmountFromString(str) {
  if (typeof str === 'number') return str;
  if (typeof str === 'string' && str.includes('(R')) {
    const amountMatch = str.match(/\(R([0-9.]+)\)/);
    if (amountMatch) {
      return parseFloat(amountMatch[1]);
    }
  }
  return 0;
}

// NEW: Check if member hasn't paid in 6 months
function checkRedFlagMembers() {
  const sixMonthsAgo = new Date();
  sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
  
  const redFlagMembers = members.map(member => {
    // Find payments for this member. Prefer an explicit memberId, fall back to name matching.
    const memberPayments = payments.filter(payment => {
      // If payment has a memberId, use it (robust even if names change)
      if (payment.memberId !== undefined && payment.memberId !== null) {
        return Number(payment.memberId) === members.indexOf(member);
      }

      // Otherwise fall back to normalized full-name comparison (case-insensitive)
      const paymentFullName = `${(payment.name || '').trim()} ${(payment.surname || '').trim()}`.replace(/\s+/g, ' ').trim().toLowerCase();
      const memberFullName = (member.name || '').trim().replace(/\s+/g, ' ').toLowerCase();
      return paymentFullName === memberFullName;
    })
    // Keep only payments with valid dates
    .filter(p => p && p.date && !isNaN(new Date(p.date)));

    if (memberPayments.length === 0) {
      // No valid payments -> flagged
      return { ...member, isRedFlagged: true, lastPayment: null };
    }

    // Sort payments by date (newest first) using valid dates
    memberPayments.sort((a, b) => new Date(b.date) - new Date(a.date));
    const lastPaymentDate = new Date(memberPayments[0].date);

    return {
      ...member,
      isRedFlagged: lastPaymentDate < sixMonthsAgo,
      lastPayment: lastPaymentDate
    };
  });
  
  return redFlagMembers.filter(member => member.isRedFlagged);
}

// NEW: Generate monthly collections report
function generateMonthlyCollectionsReport() {
  const monthlyCollectionsContainer = document.getElementById('monthlyCollectionsContainer');
  monthlyCollectionsContainer.innerHTML = '';
  
  // Group payments by month
  const monthlyData = {};
  
  payments.forEach(payment => {
    const paymentDate = new Date(payment.date);
    const monthYear = `${paymentDate.getFullYear()}-${(paymentDate.getMonth() + 1).toString().padStart(2, '0')}`;
    
    if (!monthlyData[monthYear]) {
      monthlyData[monthYear] = {
        month: paymentDate.toLocaleString('default', { month: 'long', year: 'numeric' }),
        totalCollections: 0,
        totalFines: 0,
        totalTransport: 0,
        memberCount: 0,
        payments: []
      };
    }
    
    monthlyData[monthYear].totalCollections += parseFloat(payment.monthlyCollection || 0);
    monthlyData[monthYear].totalFines += extractAmountFromString(payment.fines);
    monthlyData[monthYear].totalTransport += parseFloat(payment.transport || 0);
    monthlyData[monthYear].memberCount++;
    monthlyData[monthYear].payments.push(payment);
  });
  
  // Create monthly summary cards
  const monthlySummary = document.createElement('div');
  monthlySummary.className = 'summary-cards';
  monthlySummary.innerHTML = `
    <div class="summary-card">
      <h3>Total Months</h3>
      <div class="amount">${Object.keys(monthlyData).length}</div>
    </div>
    <div class="summary-card">
      <h3>Total Collections</h3>
      <div class="amount">${formatCurrency(Object.values(monthlyData).reduce((sum, month) => sum + month.totalCollections, 0))}</div>
    </div>
    <div class="summary-card total">
      <h3>Total Revenue</h3>
      <div class="amount">${formatCurrency(Object.values(monthlyData).reduce((sum, month) => sum + month.totalCollections + month.totalFines + month.totalTransport, 0))}</div>
    </div>
  `;
  monthlyCollectionsContainer.appendChild(monthlySummary);
  
  // Create monthly breakdown
  Object.keys(monthlyData).sort().reverse().forEach(monthKey => {
    const month = monthlyData[monthKey];
    const monthSection = document.createElement('div');
    monthSection.className = 'expandable-section';
    monthSection.innerHTML = `
      <div class="expandable-header">
        <h3><i class="fas fa-calendar"></i> ${month.month}</h3>
        <span class="status-badge status-paid">${formatCurrency(month.totalCollections)}</span>
        <i class="fas fa-chevron-down expand-icon"></i>
      </div>
      <div class="expandable-content">
        <div class="expandable-content-inner">
          <div class="summary-cards">
            <div class="summary-card">
              <h3>Members Paid</h3>
              <div class="amount">${month.memberCount}</div>
            </div>
            <div class="summary-card">
              <h3>Fines Collected</h3>
              <div class="amount">${formatCurrency(month.totalFines)}</div>
            </div>
            <div class="summary-card">
              <h3>Transport Fees</h3>
              <div class="amount">${formatCurrency(month.totalTransport)}</div>
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th>Member</th>
                <th>Date</th>
                <th>Monthly Collection</th>
                <th>Fines</th>
                <th>Transport</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody>
              ${month.payments.map(payment => `
                <tr>
                  <td>${payment.name} ${payment.surname}</td>
                  <td>${payment.date}</td>
                  <td>${formatCurrency(payment.monthlyCollection)}</td>
                  <td>${formatCurrency(extractAmountFromString(payment.fines))}</td>
                  <td>${formatCurrency(payment.transport)}</td>
                  <td>${formatCurrency(payment.totalPayment)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
    `;
    monthlyCollectionsContainer.appendChild(monthSection);
  });
  
  // Add expand functionality
  document.querySelectorAll('#monthlyCollectionsContainer .expandable-header').forEach(header => {
    header.addEventListener('click', function() {
      const content = this.nextElementSibling;
      const isExpanded = content.classList.contains('expanded');
      
      if (isExpanded) {
        content.classList.remove('expanded');
        this.classList.remove('expanded');
      } else {
        content.classList.add('expanded');
        this.classList.add('expanded');
      }
    });
  });
}

// NEW: Enhanced Yearly View Report with search and proper view switching
function generateYearlyViewReport() {
  const yearlyViewContainer = document.getElementById('yearlyViewContainer');
  yearlyViewContainer.innerHTML = '';
  
  // Group payments by year
  const yearlyData = {};
  
  payments.forEach(payment => {
    const paymentDate = new Date(payment.date);
    const year = paymentDate.getFullYear().toString();
    
    if (!yearlyData[year]) {
      yearlyData[year] = {
        year: year,
        totalCollections: 0,
        totalFines: 0,
        totalTransport: 0,
        memberCount: 0,
        monthlyBreakdown: {}
      };
    }
    
    yearlyData[year].totalCollections += parseFloat(payment.monthlyCollection || 0);
    yearlyData[year].totalFines += extractAmountFromString(payment.fines);
    yearlyData[year].totalTransport += parseFloat(payment.transport || 0);
    yearlyData[year].memberCount++;
    
    // Monthly breakdown
    const month = (paymentDate.getMonth() + 1).toString().padStart(2, '0');
    if (!yearlyData[year].monthlyBreakdown[month]) {
      yearlyData[year].monthlyBreakdown[month] = 0;
    }
    yearlyData[year].monthlyBreakdown[month] += parseFloat(payment.monthlyCollection || 0);
  });
  
  // Create yearly summary
  Object.keys(yearlyData).sort().reverse().forEach(yearKey => {
    const year = yearlyData[yearKey];
    const yearSection = document.createElement('div');
    yearSection.className = 'expandable-section';
    
    // Create chart data for monthly breakdown
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const monthlyData = months.map((month, index) => {
      const monthKey = (index + 1).toString().padStart(2, '0');
      return year.monthlyBreakdown[monthKey] || 0;
    });
    
    yearSection.innerHTML = `
      <div class="expandable-header">
        <h3><i class="fas fa-calendar-alt"></i> ${year.year}</h3>
        <span class="status-badge status-paid">${formatCurrency(year.totalCollections)}</span>
        <i class="fas fa-chevron-down expand-icon"></i>
      </div>
      <div class="expandable-content">
        <div class="expandable-content-inner">
          <!-- Yearly summary and month/table moved into the Organizational view below -->
          
          <!-- NEW: Enhanced Performance Toggle -->
          <div class="performance-toggle">
            <button class="performance-btn active" id="organizationalPerformanceBtn-${year.year}">
              <i class="fas fa-building"></i> Organizational Performance
            </button>
            <button class="performance-btn" id="membersPerformanceBtn-${year.year}">
              <i class="fas fa-users"></i> Members Performance
            </button>
          </div>
          
          <!-- NEW: Enhanced Organizational Performance Section -->
          <div class="performance-view-container active" id="organizationalPerformance-${year.year}">
            <div class="organizational-performance-container">
              <div class="organizational-performance-header">
                <h3><i class="fas fa-building"></i> Organizational Progress</h3>
                <div class="status-badge status-paid">${formatCurrency(year.totalCollections)}</div>
              </div>
              <!-- Yearly summary moved here -->
              <div class="yearly-summary">
                <div class="yearly-stat">
                  <h4>Total Members</h4>
                  <div class="amount">${members.length}</div>
                </div>
                <div class="yearly-stat">
                  <h4>Fines Collected</h4>
                  <div class="amount">${formatCurrency(year.totalFines)}</div>
                </div>
                <div class="yearly-stat">
                  <h4>Transport Fees</h4>
                  <div class="amount">${formatCurrency(year.totalTransport)}</div>
                </div>
                <div class="yearly-stat total">
                  <h4>Total Revenue</h4>
                  <div class="amount">${formatCurrency(year.totalCollections + year.totalFines + year.totalTransport)}</div>
                </div>
              </div>

              <!-- Month / Collections / Percentage table moved here -->
              <div style="margin: 1rem 0;">
                <table>
                  <thead>
                    <tr>
                      <th>Month</th>
                      <th>Collections</th>
                      <th>Percentage</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${months.map((month, index) => {
                      const monthKey = (index + 1).toString().padStart(2, '0');
                      const amount = year.monthlyBreakdown[monthKey] || 0;
                      const percentage = year.totalCollections > 0 ? ((amount / year.totalCollections) * 100).toFixed(1) : 0;
                      return `
                        <tr>
                          <td>${month}</td>
                          <td>${formatCurrency(amount)}</td>
                          <td class="percentage-cell">
                            <div class="percentage-bar-container">
                              <div class="percentage-bar monthly-bar-${index+1}" style="width: ${percentage}%">
                                <div class="percentage-text">${percentage}%</div>
                              </div>
                            </div>
                          </td>
                        </tr>
                      `;
                    }).join('')}
                  </tbody>
                </table>
              </div>
              <div style="margin: 1.5rem 0 2rem 0;">
                <h4 style="margin-bottom: 0.75rem; color: var(--secondary);">Monthly Collections Breakdown</h4>
                <div style="background: var(--card-bg); padding: 1rem; border-radius: 10px; box-shadow: var(--shadow);">
                  <canvas id="yearlyChart-${year.year}" height="100"></canvas>
                </div>
              </div>
              
              <div class="monthly-goal-container">
                <h4>Monthly Collection Goal Progress</h4>
                <div class="progress-container">
                  <div class="progress-bar">
                    <div class="progress-fill" style="width: ${Math.min(100, (year.totalCollections / (1200 * members.length)) * 100)}%">
                      <div class="progress-percentage">${Math.min(100, (year.totalCollections / (1200 * members.length)) * 100).toFixed(1)}%</div>
                    </div>
                  </div>
                  <div class="progress-text">
                    <span>Collected: ${formatCurrency(year.totalCollections)}</span>
                    <span>Goal: ${formatCurrency(1200 * members.length)}</span>
                  </div>
                </div>
              </div>
              
              <div class="monthly-breakdown-grid">
                <div class="monthly-breakdown-card">
                  <h5>Monthly Collections</h5>
                  <div class="amount">${formatCurrency(year.totalCollections)}</div>
                  <div class="percentage">${((year.totalCollections / (1200 * members.length)) * 100).toFixed(1)}% of goal</div>
                </div>
                <div class="monthly-breakdown-card">
                  <h5>Fines Collected</h5>
                  <div class="amount">${formatCurrency(year.totalFines)}</div>
                  <div class="percentage">Additional revenue</div>
                </div>
                <div class="monthly-breakdown-card">
                  <h5>Transport Fees</h5>
                  <div class="amount">${formatCurrency(year.totalTransport)}</div>
                  <div class="percentage">Additional revenue</div>
                </div>
                <div class="monthly-breakdown-card">
                  <h5>Total Revenue</h5>
                  <div class="amount">${formatCurrency(year.totalCollections + year.totalFines + year.totalTransport)}</div>
                  <div class="percentage">Overall performance</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- NEW: Enhanced Members Performance Section -->
          <div class="performance-view-container" id="membersPerformance-${year.year}">
            <div class="organizational-performance-container">
              <div class="organizational-performance-header">
                <h3><i class="fas fa-users"></i> Member Performance</h3>
                <div class="status-badge status-paid">${members.length} Members</div>
              </div>
              
              <div class="yearly-view-search">
                <input type="text" id="yearlyMemberSearch-${year.year}" placeholder="Search members by name...">
              </div>
              <div id="yearlyMemberPerformance-${year.year}">
                <!-- Member performance will be populated here -->
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
    yearlyViewContainer.appendChild(yearSection);
    
    // Create chart after DOM is updated
    setTimeout(() => {
      const ctx = document.getElementById(`yearlyChart-${year.year}`)?.getContext('2d');
      if (ctx) {
        // Bright and unique colors for each month
        const backgroundColors = [
          '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD',
          '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9', '#F8C471', '#82E0AA'
        ];
        
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: months,
            datasets: [{
              label: 'Monthly Collections',
              data: monthlyData,
              backgroundColor: backgroundColors,
              borderColor: backgroundColors,
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return 'R' + value;
                  }
                }
              }
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return `R${context.parsed.y}`;
                  }
                }
              }
            }
          }
        });
      }
      
      // Generate member performance for this year
      generateYearlyMemberPerformance(year.year, year.totalCollections);
      
      // Add event listeners for performance toggle
      document.getElementById(`organizationalPerformanceBtn-${year.year}`).addEventListener('click', function() {
        // Update active button
        document.querySelectorAll(`#organizationalPerformanceBtn-${year.year}, #membersPerformanceBtn-${year.year}`).forEach(btn => {
          btn.classList.remove('active');
        });
        this.classList.add('active');
        
        // Show organizational performance, hide members performance
        document.getElementById(`organizationalPerformance-${year.year}`).classList.add('active');
        document.getElementById(`membersPerformance-${year.year}`).classList.remove('active');
      });
      
      document.getElementById(`membersPerformanceBtn-${year.year}`).addEventListener('click', function() {
        // Update active button
        document.querySelectorAll(`#organizationalPerformanceBtn-${year.year}, #membersPerformanceBtn-${year.year}`).forEach(btn => {
          btn.classList.remove('active');
        });
        this.classList.add('active');
        
        // Show members performance, hide organizational performance
        document.getElementById(`organizationalPerformance-${year.year}`).classList.remove('active');
        document.getElementById(`membersPerformance-${year.year}`).classList.add('active');
      });
      
      // Add search functionality
      document.getElementById(`yearlyMemberSearch-${year.year}`).addEventListener('input', function() {
        generateYearlyMemberPerformance(year.year, year.totalCollections, this.value);
      });
    }, 100);
  });
  
  // Add expand functionality
  document.querySelectorAll('#yearlyViewContainer .expandable-header').forEach(header => {
    header.addEventListener('click', function() {
      const content = this.nextElementSibling;
      const isExpanded = content.classList.contains('expanded');
      
      if (isExpanded) {
        content.classList.remove('expanded');
        this.classList.remove('expanded');
      } else {
        content.classList.add('expanded');
        this.classList.add('expanded');
      }
    });
  });
}

// NEW: Enhanced Yearly Member Performance with search and goal indicator
function generateYearlyMemberPerformance(year, yearlyTotal, searchTerm = '') {
  const container = document.getElementById(`yearlyMemberPerformance-${year}`);
  if (!container) return;
  
  container.innerHTML = '';
  
  // Calculate performance metrics for each member
  const memberPerformance = members.map(member => {
    // Find payments for this member in the specific year
    const memberPayments = payments.filter(payment => {
      const paymentDate = new Date(payment.date);
      const paymentYear = paymentDate.getFullYear().toString();
      
      if (paymentYear !== year) return false;
      
      const paymentName = `${payment.name} ${payment.surname}`;
      return paymentName === member.name;
    });
    
    // Calculate total monthly collections for this year
    const totalMonthlyCollections = memberPayments.reduce((sum, payment) => {
      return sum + (parseFloat(payment.monthlyCollection) || 0);
    }, 0);
    
    // Calculate distance from R1200 goal
    const goal = 1200;
    const distanceFromGoal = goal - totalMonthlyCollections;
    const percentageOfGoal = (totalMonthlyCollections / goal) * 100;
    
    return {
      member,
      totalMonthlyCollections,
      distanceFromGoal,
      percentageOfGoal: Math.min(100, percentageOfGoal),
      paymentCount: memberPayments.length
    };
  });
  
  // Filter by search term if provided
  let filteredPerformance = memberPerformance;
  if (searchTerm) {
    const searchLower = searchTerm.toLowerCase();
    filteredPerformance = memberPerformance.filter(performance => {
      const memberName = performance.member.name.toLowerCase();
      const memberNumber = performance.member.memberNumber.toLowerCase();
      return memberName.includes(searchLower) || memberNumber.includes(searchLower);
    });
  }
  
  // Sort by total collections (highest first)
  filteredPerformance.sort((a, b) => b.totalMonthlyCollections - a.totalMonthlyCollections);
  
  // Create performance cards for each member
  filteredPerformance.forEach(performance => {
    const card = document.createElement('div');
    card.className = 'member-performance-card';
    
    card.innerHTML = `
      <div class="member-performance-header">
        <div class="member-performance-name">
          ${performance.member.name} (${performance.member.memberNumber})
        </div>
        <div class="member-performance-rating">
          ${performance.paymentCount} payments
        </div>
      </div>
      <div class="member-performance-stats">
        <div class="performance-stat payments">
          <div class="label">Monthly Collections</div>
          <div class="value">${formatCurrency(performance.totalMonthlyCollections)}</div>
        </div>
        <div class="performance-stat">
          <div class="label">Distance from Goal</div>
          <div class="value" style="color: ${performance.distanceFromGoal <= 0 ? 'var(--success)' : 'var(--accent)'}">
            ${performance.distanceFromGoal <= 0 ? 'Goal Achieved!' : formatCurrency(performance.distanceFromGoal)}
          </div>
        </div>
        <div class="performance-stat">
          <div class="label">Progress</div>
          <div class="value">${performance.percentageOfGoal.toFixed(1)}%</div>
        </div>
      </div>
      <div class="progress-bar" style="margin-top: 1rem; height: 20px; position: relative;">
        <div class="progress-fill" style="width: ${performance.percentageOfGoal}%">
          <div class="progress-percentage" style="font-size: 0.8rem;">${performance.percentageOfGoal.toFixed(1)}%</div>
        </div>
      </div>
      <div class="member-goal-indicator">
        <i class="fas fa-bullseye"></i>
        Goal: R1200
      </div>
    `;
    
    container.appendChild(card);
  });
  
  // Add summary statistics
  const membersAchievedGoal = filteredPerformance.filter(m => m.distanceFromGoal <= 0).length;
  const averageProgress = filteredPerformance.length > 0 ? 
    filteredPerformance.reduce((sum, p) => sum + p.percentageOfGoal, 0) / filteredPerformance.length : 0;
  
  const summary = document.createElement('div');
  summary.className = 'summary-cards';
  summary.innerHTML = `
    <div class="summary-card">
      <h3>Members Achieved Goal</h3>
      <div class="amount">${membersAchievedGoal}</div>
    </div>
    <div class="summary-card">
      <h3>Average Progress</h3>
      <div class="amount">${averageProgress.toFixed(1)}%</div>
    </div>
    <div class="summary-card">
      <h3>Total Members</h3>
      <div class="amount">${filteredPerformance.length}</div>
    </div>
    <div class="summary-card total">
      <h3>Goal Completion Rate</h3>
      <div class="amount">${filteredPerformance.length > 0 ? ((membersAchievedGoal / filteredPerformance.length) * 100).toFixed(1) : 0}%</div>
    </div>
  `;
  
  container.insertBefore(summary, container.firstChild);
  
  // Show message if no members found
  if (filteredPerformance.length === 0) {
    const noResults = document.createElement('div');
    noResults.style.textAlign = 'center';
    noResults.style.padding = '2rem';
    noResults.style.color = 'var(--text-light)';
    noResults.innerHTML = `
      <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem;"></i>
      <p>No members found matching your search.</p>
    `;
    container.appendChild(noResults);
  }
}

// NEW: Generate red flag report
function generateRedFlagReport() {
  const redFlagContainer = document.getElementById('redFlagContainer');
  redFlagContainer.innerHTML = '';
  
  const redFlagMembers = checkRedFlagMembers();
  
  if (redFlagMembers.length === 0) {
    redFlagContainer.innerHTML = `
      <div style="text-align: center; padding: 3rem; background: var(--card-bg); border-radius: 12px; box-shadow: var(--shadow);">
        <i class="fas fa-check-circle" style="font-size: 3rem; color: var(--success); margin-bottom: 1rem;"></i>
        <h3 style="color: var(--success); margin-bottom: 1rem;">No Red Flagged Members</h3>
        <p class="small-muted">All members have made payments within the last 6 months.</p>
      </div>
    `;
    return;
  }
  
  // Create summary
  const summarySection = document.createElement('div');
  summarySection.className = 'summary-cards';
  summarySection.innerHTML = `
    <div class="summary-card">
      <h3>Red Flagged Members</h3>
      <div class="amount" style="color: var(--accent);">${redFlagMembers.length}</div>
    </div>
    <div class="summary-card">
      <h3>Percentage of Total</h3>
      <div class="amount" style="color: var(--accent);">${((redFlagMembers.length / members.length) * 100).toFixed(1)}%</div>
    </div>
    <div class="summary-card total">
      <h3>Action Required</h3>
      <div class="amount" style="color: var(--accent);">Immediate</div>
    </div>
  `;
  redFlagContainer.appendChild(summarySection);
  
  // Create table
  const tableSection = document.createElement('div');
  tableSection.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>Member Number</th>
          <th>Full Name</th>
          <th>ID Number</th>
          <th>Phone</th>
          <th>Last Payment</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        ${redFlagMembers.map(member => `
          <tr class="flagged-member">
            <td>${member.memberNumber}</td>
            <td>${member.name}</td>
            <td>${member.idNumber}</td>
            <td>${member.phone}</td>
            <td>${member.lastPayment ? member.lastPayment.toLocaleDateString() : 'Never'}</td>
            <td>
              <span class="payment-status status-overdue">Overdue</span>
            </td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
  redFlagContainer.appendChild(tableSection);
}

// MODIFIED: Generate transport report with due/paid tabs
function generateTransportReport() {
  // Get all transport payments
  const transportPayments = payments.filter(payment => parseFloat(payment.transport || 0) > 0);
  
  // Update the transport tabs
  updateTransportDueTab();
  updateTransportPaidTab(transportPayments);
  
  // Show summary
  const paidTransport = transportPayments
    .filter(payment => !payment.isDue)
    .reduce((sum, payment) => sum + parseFloat(payment.transport || 0), 0);
  
  const dueTransport = transportPayments
    .filter(payment => payment.isDue)
    .reduce((sum, payment) => sum + parseFloat(payment.transport || 0), 0);
  
  const transportContainer = document.getElementById('transportContainer');
  if (transportContainer) {
    transportContainer.innerHTML = '';
    
    const transportSummary = document.createElement('div');
    transportSummary.className = 'summary-cards';
    transportSummary.innerHTML = `
      <div class="summary-card">
        <h3>Total Transport Collected</h3>
        <div class="amount">${formatCurrency(paidTransport)}</div>
      </div>
      <div class="summary-card">
        <h3>Transport Due</h3>
        <div class="amount" style="color: var(--accent);">${formatCurrency(dueTransport)}</div>
      </div>
      <div class="summary-card">
        <h3>Transport Payments Made</h3>
        <div class="amount">${transportPayments.filter(p => !p.isDue).length}</div>
      </div>
      <div class="summary-card">
        <h3>Transport Payments Due</h3>
        <div class="amount" style="color: var(--accent);">${transportPayments.filter(p => p.isDue).length}</div>
      </div>
    `;
    transportContainer.appendChild(transportSummary);
  }
}

// MODIFIED: Update Transport Due Tab to show only due payments
function updateTransportDueTab() {
  const transportDueContainer = document.getElementById('transportDueContainer');
  if (!transportDueContainer) return;
  
  transportDueContainer.innerHTML = '';
  
  // MODIFIED: Get only due transport payments
  const dueTransportPayments = payments.filter(payment => 
    payment.isDue && parseFloat(payment.transport || 0) > 0
  );
  
  if (dueTransportPayments.length === 0) {
    transportDueContainer.innerHTML = `
      <div style="text-align: center; padding: 3rem; background: var(--card-bg); border-radius: 12px; box-shadow: var(--shadow);">
        <i class="fas fa-check-circle" style="font-size: 3rem; color: var(--success); margin-bottom: 1rem;"></i>
        <h3 style="color: var(--success); margin-bottom: 1rem;">All Transport Paid</h3>
        <p class="small-muted">All transport fees have been paid.</p>
      </div>
    `;
    return;
  }
  
  const tableSection = document.createElement('div');
  tableSection.innerHTML = `
    <h3 style="margin: 2rem 0 1rem 0; color: var(--secondary);">
      <i class="fas fa-list"></i> Members Due for Transport Payment
    </h3>
    <table>
      <thead>
        <tr>
          <th>Member</th>
          <th>Date Charged</th>
          <th>Transport Fee</th>
          <th>Funeral For</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        ${dueTransportPayments.map(payment => `
          <tr class="flagged-member">
            <td>${payment.name} ${payment.surname}</td>
            <td>${payment.date}</td>
            <td>${formatCurrency(payment.transport)}</td>
            <td>${payment.funeralFor || 'Not specified'}</td>
            <td>
              <span class="payment-status status-overdue">Unpaid</span>
            </td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
  transportDueContainer.appendChild(tableSection);
}

// MODIFIED: Update Transport Paid Tab to show only paid transport payments
function updateTransportPaidTab(transportPayments) {
  const transportPaidContainer = document.getElementById('transportPaidContainer');
  if (!transportPaidContainer) return;
  
  transportPaidContainer.innerHTML = '';
  
  // MODIFIED: Get only paid transport payments (not due)
  const paidTransportPayments = transportPayments.filter(payment => 
    !payment.isDue && parseFloat(payment.transport || 0) > 0
  );
  
  if (paidTransportPayments.length === 0) {
    transportPaidContainer.innerHTML = `
      <div style="text-align: center; padding: 3rem; background: var(--card-bg); border-radius: 12px; box-shadow: var(--shadow);">
        <i class="fas fa-info-circle" style="font-size: 3rem; color: var(--warning); margin-bottom: 1rem;"></i>
        <h3 style="color: var(--warning); margin-bottom: 1rem;">No Transport Payments</h3>
        <p class="small-muted">No transport payments have been recorded yet.</p>
      </div>
    `;
    return;
  }
  
  const tableSection = document.createElement('div');
  tableSection.innerHTML = `
    <h3 style="margin: 2rem 0 1rem 0; color: var(--secondary);">
      <i class="fas fa-list"></i> Transport Payment Details
    </h3>
    <table>
      <thead>
        <tr>
          <th>Member</th>
          <th>Date Paid</th>
          <th>Transport Fee</th>
          <th>Funeral For</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        ${paidTransportPayments.map(payment => `
          <tr>
            <td>${payment.name} ${payment.surname}</td>
            <td>${payment.date}</td>
            <td>${formatCurrency(payment.transport)}</td>
            <td>${payment.funeralFor || 'Not specified'}</td>
            <td>
              <span class="payment-status status-paid">Paid</span>
            </td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
  transportPaidContainer.appendChild(tableSection);
}

// NEW: Generate transport breakdown
function generateTransportBreakdown() {
  const breakdownContainer = document.getElementById('transportBreakdownContainer');
  if (!breakdownContainer) return;
  
  breakdownContainer.innerHTML = '';
  
  // Get all transport payments
  const transportPayments = payments.filter(payment => parseFloat(payment.transport || 0) > 0);
  
  // Calculate breakdown
  const paidTransport = transportPayments
    .filter(payment => !payment.isDue)
    .reduce((sum, payment) => sum + parseFloat(payment.transport || 0), 0);
  
  const dueTransport = transportPayments
    .filter(payment => payment.isDue)
    .reduce((sum, payment) => sum + parseFloat(payment.transport || 0), 0);
  
  const paidCount = transportPayments.filter(p => !p.isDue).length;
  const dueCount = transportPayments.filter(p => p.isDue).length;
  
  const breakdownSection = document.createElement('div');
  breakdownSection.className = 'breakdown-section';
  breakdownSection.innerHTML = `
    <h3><i class="fas fa-chart-pie"></i> Transport Fee Breakdown</h3>
    <div class="summary-cards">
      <div class="summary-card">
        <h3>Total Paid</h3>
        <div class="amount">${formatCurrency(paidTransport)}</div>
        <p>${paidCount} payments</p>
      </div>
      <div class="summary-card">
        <h3>Total Due</h3>
        <div class="amount" style="color: var(--accent);">${formatCurrency(dueTransport)}</div>
        <p>${dueCount} payments</p>
      </div>
      <div class="summary-card total">
        <h3>Total Potential</h3>
        <div class="amount">${formatCurrency(paidTransport + dueTransport)}</div>
        <p>${paidCount + dueCount} total</p>
      </div>
    </div>
    
    <h4 style="margin-top: 2rem; color: var(--secondary);">Members Who Have Paid</h4>
    <table>
      <thead>
        <tr>
          <th>Member</th>
          <th>Amount Paid</th>
          <th>Funeral For</th>
        </tr>
      </thead>
      <tbody>
        ${transportPayments.filter(p => !p.isDue).map(payment => `
          <tr>
            <td>${payment.name} ${payment.surname}</td>
            <td>${formatCurrency(payment.transport)}</td>
            <td>${payment.funeralFor || 'Not specified'}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
    
    <h4 style="margin-top: 2rem; color: var(--accent);">Members Who Owe</h4>
    <table>
      <thead>
        <tr>
          <th>Member</th>
          <th>Amount Due</th>
          <th>Funeral For</th>
        </tr>
      </thead>
      <tbody>
        ${transportPayments.filter(p => p.isDue).map(payment => `
          <tr class="flagged-member">
            <td>${payment.name} ${payment.surname}</td>
            <td>${formatCurrency(payment.transport)}</td>
            <td>${payment.funeralFor || 'Not specified'}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
  
  breakdownContainer.appendChild(breakdownSection);
}

// NEW: Toggle funeral for input when transport button is clicked
transportPaymentBtn.addEventListener('click', function() {
  funeralForInput.style.display = funeralForInput.style.display === 'none' ? 'block' : 'none';
  if (funeralForInput.style.display === 'block') {
    funeralForInput.focus();
  }
});

// MODIFIED: Payment Form Submission - Handle transport payments
paymentForm.addEventListener('submit', e => {
  e.preventDefault();
  
  const memberIndex = document.getElementById('paymentMember').value;
  if (!memberIndex) {
    alert('Please select a member');
    return;
  }
  
  const member = members[memberIndex];
  if (!member) {
    return;
  }
  
  const date = document.getElementById('paymentDate').value;
  const monthlyCollection = parseFloat(document.getElementById('monthlyCollection').value) || 0;
  const dressCode = document.getElementById('dressCode').value;
  const fineType = document.getElementById('fineType').value;
  const fineAmount = parseFloat(document.getElementById('fineAmount').value) || 0;
  const transport = parseFloat(document.getElementById('transport').value) || 0;
  const funeralFor = document.getElementById('funeralFor').value || '';
  
  // MODIFIED: Check if this is a transport payment for an existing due transport
  let isTransportPayment = false;
  if (transport > 0) {
    // Find if there's a due transport payment for this member
    const dueTransportPaymentIndex = payments.findIndex(payment => {
      const paymentName = `${payment.name} ${payment.surname}`;
      return paymentName === member.name && payment.isDue && payment.transport > 0;
    });
    
    if (dueTransportPaymentIndex !== -1) {
      // Update the existing due transport payment to paid
      payments[dueTransportPaymentIndex].isDue = false;
      payments[dueTransportPaymentIndex].date = date;
      payments[dueTransportPaymentIndex].funeralFor = funeralFor;
      isTransportPayment = true;
    }
  }
  
  // Only create a new payment if this isn't a transport payment for an existing due
  if (!isTransportPayment) {
    // Create payment object
    const paymentObj = {
      bookNo: member.memberNumber || payments.length + 1,
      name: member.name.split(' ')[0],
      surname: member.name.split(' ').slice(1).join(' ') || '',
      date,
      monthlyCollection,
      dressCode,
      // NEW: Handle fines with amount (paid) or without amount (due)
      fines: fineType ? `${fineType}${fineAmount > 0 ? ` (R${fineAmount.toFixed(2)}) - Paid` : ' - Due'}` : '',
      transport,
      funeralFor,
      memberId: memberIndex,
      isDue: false // Default to paid
    };
    
    // Calculate total payment
    paymentObj.totalPayment = calculateTotalPayment(paymentObj);
    
    payments.push(paymentObj);
  }
  
  savePayments();
  renderPayments();
  renderMembers();
  updatePaymentSummary();
  paymentForm.reset();
  document.getElementById('paymentDate').valueAsDate = new Date();
  funeralForInput.style.display = 'none';
  
  showToast('Payment recorded successfully!');
});

// MODIFIED: Charge transport fee to all members - now marks as due
function chargeTransportFeeToAll() {
  const today = new Date().toISOString().split('T')[0];
  const funeralFor = prompt('Enter the name of the deceased for this transport collection:') || '';
  
  members.forEach(member => {
    // Check if member already has a transport payment for today
    const existingPayment = payments.find(payment => {
      const paymentName = `${payment.name} ${payment.surname}`;
      return paymentName === member.name && payment.date === today && parseFloat(payment.transport || 0) > 0;
    });
    
    if (!existingPayment) {
      const transportPayment = {
        bookNo: member.memberNumber || payments.length + 1,
        name: member.name.split(' ')[0],
        surname: member.name.split(' ').slice(1).join(' ') || '',
        date: today,
        monthlyCollection: 0,
        dressCode: '',
        fines: '',
        transport: 20,
        funeralFor: funeralFor,
        totalPayment: 20,
        isDue: true // MODIFIED: Mark as due until paid
      };
      
      payments.push(transportPayment);
    }
  });
  
  savePayments();
  renderPayments();
  updatePaymentSummary();
  showToast(`R20 transport fee charged to all members for ${funeralFor || 'today'}!`);
}

// FIXED: Payment Edit Modal
function openEditPaymentModal(index) {
  editPaymentIndex = index;
  const payment = payments[index];
  
  document.getElementById('editPaymentDate').value = payment.date;
  document.getElementById('editMonthlyCollection').value = payment.monthlyCollection || '';
  document.getElementById('editDressCode').value = payment.dressCode || '';
  
  // Extract fine type and amount
  if (payment.fines && payment.fines.includes('(')) {
    const fineParts = payment.fines.split(' (');
    document.getElementById('editFineType').value = fineParts[0] || '';
    if (fineParts[1]) {
      const amountMatch = fineParts[1].match(/R([0-9.]+)/);
      if (amountMatch) {
        document.getElementById('editFineAmount').value = amountMatch[1];
      }
    }
  } else {
    const fineParts = payment.fines ? payment.fines.split(' - ') : [''];
    document.getElementById('editFineType').value = fineParts[0] || '';
    document.getElementById('editFineAmount').value = '';
  }
  
  document.getElementById('editTransport').value = payment.transport || '';
  document.getElementById('editFuneralFor').value = payment.funeralFor || '';
  
  document.getElementById('paymentEditModal').style.display = 'flex';
}

// FIXED: Save Payment Edit
document.getElementById('savePaymentEdit').addEventListener('click', function() {
  if (editPaymentIndex === null) return;
  
  const payment = payments[editPaymentIndex];
  
  // Update payment data
  payment.date = document.getElementById('editPaymentDate').value;
  payment.monthlyCollection = parseFloat(document.getElementById('editMonthlyCollection').value) || 0;
  payment.dressCode = document.getElementById('editDressCode').value;
  
  const fineType = document.getElementById('editFineType').value;
  const fineAmount = parseFloat(document.getElementById('editFineAmount').value) || 0;
  // NEW: Handle fines with amount (paid) or without amount (due)
  payment.fines = fineType ? `${fineType}${fineAmount > 0 ? ` (R${fineAmount.toFixed(2)}) - Paid` : ' - Due'}` : '';
  
  payment.transport = parseFloat(document.getElementById('editTransport').value) || 0;
  payment.funeralFor = document.getElementById('editFuneralFor').value || '';
  
  // Recalculate total payment
  payment.totalPayment = calculateTotalPayment(payment);
  
  savePayments();
  renderPayments();
  updatePaymentSummary();
  document.getElementById('paymentEditModal').style.display = 'none';
  editPaymentIndex = null;
  
  showToast('Payment updated successfully!');
});

// FIXED: Payment Delete Modal
function openPaymentDeleteModal(index) {
  deletePaymentIndex = index;
  document.getElementById('paymentDeleteModal').style.display = 'flex';
}

// FIXED: Confirm Payment Delete
document.getElementById('confirmPaymentDelete').addEventListener('click', function() {
  if (deletePaymentIndex === null) return;
  
  payments.splice(deletePaymentIndex, 1);
  savePayments();
  renderPayments();
  updatePaymentSummary();
  document.getElementById('paymentDeleteModal').style.display = 'none';
  deletePaymentIndex = null;
  
  showToast('Payment deleted successfully!');
});

// FIXED: Edit Member Modal
function openEditMemberModal(index) {
  currentMemberIndex = index;
  const member = members[index];
  
  document.getElementById('editMemberNumber').value = member.memberNumber || '';
  document.getElementById('editName').value = member.name || '';
  document.getElementById('editIdNumber').value = member.idNumber || '';
  document.getElementById('editPhone').value = member.phone || '';
  
  document.getElementById('editMemberModal').style.display = 'flex';
}

// FIXED: Save Member Edit
document.getElementById('saveMemberEdit').addEventListener('click', function() {
  if (currentMemberIndex === null) return;
  
  const member = members[currentMemberIndex];
  
  // Update member data
  member.memberNumber = document.getElementById('editMemberNumber').value.trim();
  member.name = document.getElementById('editName').value.trim();
  member.idNumber = document.getElementById('editIdNumber').value.trim();
  member.phone = document.getElementById('editPhone').value.trim();
  
  saveMembers();
  renderMembers(searchInput.value.trim());
  updatePaymentMemberDropdown();
  document.getElementById('editMemberModal').style.display = 'none';
  currentMemberIndex = null;
  
  showToast('Member updated successfully!');
});

// FIXED: Member Delete functionality
document.getElementById('confirmDelete').addEventListener('click', function() {
  if (deleteIndex === null) return;
  
  // Also remove any payments associated with this member
  const member = members[deleteIndex];
  payments = payments.filter(payment => {
    const paymentName = `${payment.name} ${payment.surname}`;
    return paymentName !== member.name;
  });
  
  members.splice(deleteIndex, 1);
  saveMembers();
  savePayments();
  renderMembers(searchInput.value.trim());
  renderPayments();
  updatePaymentSummary();
  updatePaymentMemberDropdown();
  document.getElementById('deleteModal').style.display = 'none';
  deleteIndex = null;
  
  showToast('Member deleted successfully!');
});

// NEW: Event Listeners for new navigation
document.getElementById('monthlyCollectionsView').addEventListener('click', function() {
  showMonthlyCollectionsPage();
});

document.getElementById('yearlyView').addEventListener('click', function() {
  showYearlyViewPage();
});

document.getElementById('backToStatementsFromMonthly').addEventListener('click', function() {
  showReport('statements');
});

document.getElementById('backToStatementsFromYearly').addEventListener('click', function() {
  showReport('statements');
});

// NEW: Functions for navigation
function showMonthlyCollectionsPage() {
  document.querySelectorAll('.report-content').forEach(content => {
    content.classList.remove('active');
  });
  document.getElementById('monthlyCollectionsPage').classList.add('active');
  generateMonthlyCollectionsReport();
}

function showYearlyViewPage() {
  document.querySelectorAll('.report-content').forEach(content => {
    content.classList.remove('active');
  });
  document.getElementById('yearlyViewPage').classList.add('active');
  generateYearlyViewReport();
}

// FIXED: Event Listeners for report buttons
chargeTransportFeeBtn.addEventListener('click', function() {
  if (confirm('Are you sure you want to charge R20 transport fee to all members?')) {
    chargeTransportFeeToAll();
  }
});

generateTransportReportBtn.addEventListener('click', function() {
  generateTransportReport();
  showToast('Transport report generated!');
});

transportBreakdownBtn.addEventListener('click', function() {
  generateTransportBreakdown();
  showToast('Transport breakdown generated!');
});

// FIXED: Red Flag Report Button
generateRedFlagReportBtn.addEventListener('click', function() {
  generateRedFlagReport();
  showToast('Red flag report generated!');
});

// NEW: Transport Tab functionality
document.querySelectorAll('.transport-tab').forEach(tab => {
  tab.addEventListener('click', function() {
    const tabName = this.getAttribute('data-tab');
    
    // Update active tab
    document.querySelectorAll('.transport-tab').forEach(t => t.classList.remove('active'));
    this.classList.add('active');
    
    // Show active content
    document.querySelectorAll('.transport-tab-content').forEach(content => {
      content.classList.remove('active');
    });
    document.getElementById(`transport${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Tab`).classList.add('active');
  });
});

// NEW: Attendance Functions
function initializeAttendance() {
  // Set date picker to today by default (attendanceDate may be optional)
  if (document.getElementById('attendanceDate')) {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    document.getElementById('attendanceDate').value = `${yyyy}-${mm}-${dd}`;
  }
  
  // Load attendance for current month/year
  loadAttendance();
}

// NEW: Modified loadAttendance to support search
function loadAttendance(searchTerm = '') {
  // Prefer explicit date if provided
  const dateInput = document.getElementById('attendanceDate')?.value;
  let month, year;
  if (dateInput) {
    const parts = dateInput.split('-');
    year = parts[0];
    month = String(parseInt(parts[1], 10));
  } else {
    // No explicit date provided — use current month/year
    const today = new Date();
    year = String(today.getFullYear());
    month = String(today.getMonth() + 1);
  }
  const key = `${year}-${month}`;
  
  // Update member count
  totalMembersCount.textContent = members.length;
  
  // Create attendance list
  attendanceList.innerHTML = '';
  
  let filteredMembers = members;
  
  // Apply search filter if provided
  if (searchTerm) {
    const searchLower = searchTerm.toLowerCase();
    filteredMembers = members.filter(member => {
      const name = (member.name || '').toLowerCase();
      const memberNumber = (member.memberNumber || '').toString().toLowerCase();
      return name.includes(searchLower) || memberNumber.includes(searchLower);
    });
  }
  
  filteredMembers.forEach((member, index) => {
    const memberDiv = document.createElement('div');
    memberDiv.className = 'attendance-member';

    // Check if member was present (use memberNumber as stable identifier)
    const isPresent = attendance[key] && attendance[key].includes(member.memberNumber);

    // Use checkbox value equal to memberNumber so we can read/save reliably
    memberDiv.innerHTML = `
      <input type="checkbox" id="attendance-${member.memberNumber}" value="${escHtml(member.memberNumber)}" ${isPresent ? 'checked' : ''}>
      <label for="attendance-${member.memberNumber}">${escHtml(member.name)} (${escHtml(member.memberNumber)})</label>
    `;

    attendanceList.appendChild(memberDiv);
  });
  
  updateAttendanceStats();
}

function updateAttendanceStats() {
  const dateInput = document.getElementById('attendanceDate')?.value;
  let month, year;
  if (dateInput) {
    const parts = dateInput.split('-');
    year = parts[0];
    month = String(parseInt(parts[1], 10));
  } else {
    const today = new Date();
    year = String(today.getFullYear());
    month = String(today.getMonth() + 1);
  }
  const key = `${year}-${month}`;
  
  const presentMembers = attendance[key] ? attendance[key].length : 0;
  const total = members.length;
  const absentMembers = total - presentMembers;
  const rate = total > 0 ? ((presentMembers / total) * 100).toFixed(1) : 0;
  
  presentCount.textContent = presentMembers;
  absentCount.textContent = absentMembers;
  attendanceRate.textContent = `${rate}%`;
}

function saveAttendanceData() {
  // If a full date is provided use it; otherwise use month/year
  const dateInput = document.getElementById('attendanceDate')?.value;
  let month, year;
  if (dateInput) {
    const parts = dateInput.split('-');
    year = parts[0];
    month = String(parseInt(parts[1], 10));
  } else {
    // Fallback: use today's date
    const today = new Date();
    year = String(today.getFullYear());
    month = String(today.getMonth() + 1);
  }
  const key = `${year}-${month}`;

  // Get all checked members by value (memberNumber)
  const presentMembers = [];
  document.querySelectorAll('#attendanceList input[type="checkbox"]:checked').forEach((checkbox) => {
    // checkbox.value is memberNumber because we set it when rendering
    presentMembers.push(checkbox.value);
  });
  
  // Save to attendance data
  attendance[key] = presentMembers;
  saveAttendance();
  
  updateAttendanceStats();
  showToast('Attendance saved successfully!');
}

// NEW: Generate Attendance Report with breakdown
function generateAttendanceReport() {
  const container = document.getElementById('attendanceReportContainer');
  container.innerHTML = '';
  
  // Group attendance by month
  const monthlyAttendance = {};
  
  Object.keys(attendance).forEach(key => {
    const [year, month] = key.split('-');
    const monthName = new Date(year, month - 1).toLocaleString('default', { month: 'long', year: 'numeric' });
    
    if (!monthlyAttendance[year]) {
      monthlyAttendance[year] = {};
    }
    
    monthlyAttendance[year][month] = {
      month: monthName,
      present: attendance[key].length,
      total: members.length,
      rate: members.length > 0 ? ((attendance[key].length / members.length) * 100).toFixed(1) : 0,
      presentMembers: attendance[key],
      allMembers: members.map(m => m.memberNumber)
    };
  });
  
  // Create summary
  const summarySection = document.createElement('div');
  summarySection.className = 'summary-cards';
  summarySection.innerHTML = `
    <div class="summary-card">
      <h3>Months Recorded</h3>
      <div class="amount">${Object.keys(attendance).length}</div>
    </div>
    <div class="summary-card">
      <h3>Total Members</h3>
      <div class="amount">${members.length}</div>
    </div>
    <div class="summary-card total">
      <h3>Average Attendance</h3>
      <div class="amount">
        ${Object.keys(attendance).length > 0 ? 
          (Object.keys(attendance).reduce((sum, key) => sum + (attendance[key].length / members.length * 100), 0) / Object.keys(attendance).length).toFixed(1) + '%' : 
          '0%'}
      </div>
    </div>
  `;
  container.appendChild(summarySection);
  
  // Create monthly breakdown
  Object.keys(monthlyAttendance).sort().reverse().forEach(year => {
    const yearSection = document.createElement('div');
    yearSection.className = 'expandable-section';
    
    let monthlyContent = '';
    Object.keys(monthlyAttendance[year]).sort((a, b) => b - a).forEach(month => {
      const data = monthlyAttendance[year][month];
      
      // Create tabs for attendance breakdown
      monthlyContent += `
        <div class="attendance-breakdown">
          <div class="attendance-breakdown-tabs">
            <div class="attendance-breakdown-tab active" data-month="${month}" data-type="present">Present (${data.present})</div>
            <div class="attendance-breakdown-tab" data-month="${month}" data-type="absent">Absent (${data.total - data.present})</div>
          </div>
          <div class="attendance-breakdown-content active" id="attendance-${year}-${month}-present">
            <h4>Members Present in ${data.month}</h4>
            <div class="attendance-list">
              ${members.filter(member => data.presentMembers.includes(member.memberNumber)).map(member => `
                <div class="attendance-member attendance-member-present">
                  <i class="fas fa-check-circle" style="color: var(--success); margin-right: 1rem;"></i>
                  <label>${member.name} (${member.memberNumber})</label>
                </div>
              `).join('')}
            </div>
          </div>
          <div class="attendance-breakdown-content" id="attendance-${year}-${month}-absent">
            <h4>Members Absent in ${data.month}</h4>
            <div class="attendance-list">
              ${members.filter(member => !data.presentMembers.includes(member.memberNumber)).map(member => `
                <div class="attendance-member attendance-member-absent">
                  <i class="fas fa-times-circle" style="color: var(--accent); margin-right: 1rem;"></i>
                  <label>${member.name} (${member.memberNumber})</label>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    });
    
    yearSection.innerHTML = `
      <div class="expandable-header">
        <h3><i class="fas fa-calendar-alt"></i> ${year}</h3>
        <i class="fas fa-chevron-down expand-icon"></i>
      </div>
      <div class="expandable-content">
        <div class="expandable-content-inner">
          <table>
            <thead>
              <tr>
                <th>Month</th>
                <th>Present</th>
                <th>Total</th>
                <th>Attendance Rate</th>
              </tr>
            </thead>
            <tbody>
              ${Object.keys(monthlyAttendance[year]).sort((a, b) => b - a).map(month => {
                const data = monthlyAttendance[year][month];
                return `
                  <tr>
                    <td>${data.month}</td>
                    <td>${data.present}</td>
                    <td>${data.total}</td>
                    <td class="percentage-cell">
                      <div class="percentage-bar-container">
                        <div class="percentage-bar" style="width: ${data.rate}%">
                          <div class="percentage-text">${data.rate}%</div>
                        </div>
                      </div>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
          ${monthlyContent}
        </div>
      </div>
    `;
    container.appendChild(yearSection);
  });
  
  // Add expand functionality
  document.querySelectorAll('#attendanceReportContainer .expandable-header').forEach(header => {
    header.addEventListener('click', function() {
      const content = this.nextElementSibling;
      const isExpanded = content.classList.contains('expanded');
      
      if (isExpanded) {
        content.classList.remove('expanded');
        this.classList.remove('expanded');
      } else {
        content.classList.add('expanded');
        this.classList.add('expanded');
      }
    });
  });
  
  // Add attendance breakdown tab functionality
  document.querySelectorAll('.attendance-breakdown-tab').forEach(tab => {
    tab.addEventListener('click', function() {
      const month = this.getAttribute('data-month');
      const type = this.getAttribute('data-type');
      const year = Object.keys(monthlyAttendance).find(y => monthlyAttendance[y][month]);
      
      // Update active tab
      this.parentElement.querySelectorAll('.attendance-breakdown-tab').forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      
      // Show active content
      this.parentElement.parentElement.querySelectorAll('.attendance-breakdown-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`attendance-${year}-${month}-${type}`).classList.add('active');
    });
  });
}

// Navigation
document.getElementById("logoContainer").addEventListener('click', () => {
  document.getElementById("logo").classList.toggle('expanded');
});

// Navigation
navLinks.forEach(link => {
  link.addEventListener("click", (e) => {
    e.preventDefault();
    const sectionId = link.getAttribute("data-section");
    showSection(sectionId);
  });
});

// Back button functionality
document.getElementById('backToHomeFromMembers').addEventListener('click', () => showSection('home'));
document.getElementById('backToHomeFromPayments').addEventListener('click', () => showSection('home'));
document.getElementById('backToHomeFromAttendance').addEventListener('click', () => showSection('home'));
document.getElementById('backToHomeFromReports').addEventListener('click', () => showSection('home'));

// Function to show a specific section
function showSection(sectionId) {
  sections.forEach(sec => sec.classList.remove("active"));
  homeHero.style.display = sectionId === "home" ? "block" : "none";
  homeCards.style.display = sectionId === "home" ? "grid" : "none";
  
  if (sectionId && document.getElementById(sectionId)) {
    const sec = document.getElementById(sectionId);
    sec.classList.add("active");
    
    if (sectionId === "reports") {
      showReportsDashboard();
    }
    
    if (sectionId === "payments") {
      updatePaymentMemberDropdown();
      renderPayments();
      updatePaymentSummary();
      setTimeout(initializeExpandableSections, 100);
    }
    
    if (sectionId === "attendance") {
      initializeAttendance();
    }
  }
}

// Report navigation functionality
function showReport(reportName) {
  document.getElementById('reportsDashboard').style.display = 'none';
  document.querySelectorAll('.report-content').forEach(content => {
    content.classList.remove('active');
  });
  
  const reportElement = document.getElementById(`${reportName}Report`);
  if (reportElement) {
    reportElement.classList.add('active');
    
    switch(reportName) {
      case 'statements':
        // Don't auto-generate - let user choose between monthly/yearly
        break;
      case 'fines':
        generateFinesReport();
        break;
      case 'redflags':
        generateRedFlagReport();
        break;
      case 'transport':
        generateTransportReport();
        break;
      case 'attendance':
        generateAttendanceReport();
        break;
    }
  }
}

function showReportsDashboard() {
  document.querySelectorAll('.report-content').forEach(content => {
    content.classList.remove('active');
  });
  document.getElementById('reportsDashboard').style.display = 'grid';
}

// Event listeners for report cards
document.querySelectorAll('.report-card[data-report]').forEach(card => {
  card.addEventListener('click', function() {
    const reportName = this.getAttribute('data-report');
    showReport(reportName);
  });
});

// Event listeners for back buttons
document.getElementById('backToReportsFromStatements').addEventListener('click', showReportsDashboard);
document.getElementById('backToReportsFromFines').addEventListener('click', showReportsDashboard);
document.getElementById('backToReportsFromRedflags').addEventListener('click', showReportsDashboard);
document.getElementById('backToReportsFromTransport').addEventListener('click', showReportsDashboard);
document.getElementById('backToReportsFromAttendance').addEventListener('click', showReportsDashboard);

// Expandable sections functionality
function initializeExpandableSections() {
  document.querySelectorAll('.expandable-header').forEach(header => {
    header.removeEventListener('click', handleExpandableClick);
    header.addEventListener('click', handleExpandableClick);
  });
}

function handleExpandableClick() {
  const content = this.nextElementSibling;
  const icon = this.querySelector('.expand-icon') || this.querySelector('.fa-chevron-down, .fa-chevron-up');
  
  content.classList.toggle('expanded');
  this.classList.toggle('expanded');
  
  if (icon) {
    if (icon.classList.contains('fa-chevron-down')) {
      icon.classList.remove('fa-chevron-down');
      icon.classList.add('fa-chevron-up');
    } else {
      icon.classList.remove('fa-chevron-up');
      icon.classList.add('fa-chevron-down');
    }
  }
}

// Render Members - FIXED: Always sort by member number
function renderMembers(filter=''){
  memberList.innerHTML = '';
  const qRaw = (filter||'').trim();
  const q = qRaw.toLowerCase();

  // Sort members by member number
  const sortedMembers = [...members].sort((a, b) => {
    const numA = parseInt(a.memberNumber) || 0;
    const numB = parseInt(b.memberNumber) || 0;
    return numA - numB;
  });

  sortedMembers.forEach((m, index) => {
    const name = (m.name||'').toLowerCase();
    const memNum = (m.memberNumber||'').toString();
    const idxStr = String(index+1);
    const show = qRaw === '' ? true : (name.includes(q) || (memNum && memNum.includes(qRaw)) || idxStr.includes(qRaw));
    if(!show) return;

    let beneficiariesHtml = '';
    if (m.beneficiaries && m.beneficiaries.length > 0) {
      beneficiariesHtml = m.beneficiaries.map(ben => `
        <div class="beneficiaries-list">
          <div><strong>${escHtml(ben.name)}</strong></div>
          <div class="beneficiary-id">ID: ${escHtml(ben.id)} | ${escHtml(ben.relationship)}</div>
        </div>
      `).join('');
    } else {
      beneficiariesHtml = '<span class="small-muted">No beneficiaries added</span>';
    }

    const row = document.createElement('tr');
    row.innerHTML = `
      <td class="index-col">${escHtml(m.memberNumber || 'N/A')}</td>
      <td><span class="member-name" style="color:var(--secondary);cursor:pointer">${escHtml(m.name||'')}</span></td>
      <td>${escHtml(m.idNumber||'')}</td>
      <td>${escHtml(m.phone||'')}</td>
      <td>${beneficiariesHtml}</td>
      <td>
        <button class="beneficiary-btn" data-index="${members.indexOf(m)}"><i class="fas fa-user-plus"></i> Add Beneficiary</button>
        <button class="edit-btn" data-index="${members.indexOf(m)}"><i class="fas fa-edit"></i> Edit</button>
        <button class="delete-btn" data-index="${members.indexOf(m)}"><i class="fas fa-trash"></i> Delete</button>
      </td>
    `;
    memberList.appendChild(row);
  });

  // Add event listeners for member actions
  document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const index = this.getAttribute('data-index');
      openEditChoiceModal(parseInt(index));
    });
  });
  
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const index = this.getAttribute('data-index');
      openDeleteModal(parseInt(index));
    });
  });
  
  document.querySelectorAll('.beneficiary-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const index = this.getAttribute('data-index');
      openAddBeneficiaryModal(parseInt(index));
    });
  });
}

// Update payment member dropdown
function updatePaymentMemberDropdown() {
  paymentMemberSelect.innerHTML = '<option value="">Select Member</option>';
  
  // Sort members by member number
  const sortedMembers = [...members].sort((a, b) => {
    const numA = parseInt(a.memberNumber) || 0;
    const numB = parseInt(b.memberNumber) || 0;
    return numA - numB;
  });
  
  sortedMembers.forEach((member, index) => {
    const option = document.createElement('option');
    option.value = members.indexOf(member);
    option.textContent = `${member.name} ${member.memberNumber ? `(${member.memberNumber})` : ''}`;
    paymentMemberSelect.appendChild(option);
  });
}

// Render Payments with search functionality
function renderPayments(searchTerm = '') {
  paymentList.innerHTML = '';
  
  let filteredPayments = payments;
  
  // Apply search filter if provided
  if (searchTerm) {
    const searchLower = searchTerm.toLowerCase();
    filteredPayments = payments.filter(payment => {
      const fullName = `${payment.name} ${payment.surname}`.toLowerCase();
      return fullName.includes(searchLower);
    });
  }
  
  filteredPayments.forEach((payment, index) => {
    payment.totalPayment = calculateTotalPayment(payment);
    
    const member = members.find(m => 
      m.name.split(' ')[0] === payment.name && 
      m.name.split(' ').slice(1).join(' ') === payment.surname
    );
    
    const bookNo = member && member.memberNumber ? member.memberNumber : payment.bookNo;
    
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${bookNo || ''}</td>
      <td>${escHtml(payment.name || '')}</td>
      <td>${escHtml(payment.surname || '')}</td>
      <td>${payment.date || ''}</td>
      <td>${payment.monthlyCollection ? formatCurrency(payment.monthlyCollection) : 'R0.00'}</td>
      <td>${payment.dressCode ? `${payment.dressCode} (${formatCurrency(payment.dressCode === 'Jacket' ? 750 : 500)})` : ''}</td>
      <td>${payment.fines || ''}</td>
      <td>${payment.transport ? formatCurrency(payment.transport) : 'R0.00'}</td>
      <td>${formatCurrency(payment.totalPayment)}</td>
      <td>
        <button class="edit-btn" data-payment-index="${payments.indexOf(payment)}"><i class="fas fa-edit"></i> Edit</button>
        <button class="delete-btn" data-payment-index="${payments.indexOf(payment)}"><i class="fas fa-trash"></i> Delete</button>
      </td>
    `;
    paymentList.appendChild(row);
  });
  
  // Add event listeners for payment actions
  document.querySelectorAll('[data-payment-index]').forEach(btn => {
    if (btn.classList.contains('edit-btn')) {
      btn.addEventListener('click', function() {
        const index = this.getAttribute('data-payment-index');
        openEditPaymentModal(parseInt(index));
      });
    } else if (btn.classList.contains('delete-btn')) {
      btn.addEventListener('click', function() {
        const index = this.getAttribute('data-payment-index');
        openPaymentDeleteModal(parseInt(index));
      });
    }
  });
}

// Update Payment Summary
function updatePaymentSummary() {
  let totalCollected = 0;
  let monthlyCollections = 0;
  let finesCollected = 0;
  let transportMoney = 0;
  
  payments.forEach(payment => {
    totalCollected += parseFloat(payment.totalPayment || 0);
    
    if (typeof payment.monthlyCollection === 'number') {
      monthlyCollections += payment.monthlyCollection;
    }
    
    finesCollected += extractAmountFromString(payment.fines);
    
    if (typeof payment.transport === 'number') {
      transportMoney += payment.transport;
    }
  });
  
  document.getElementById('totalCollected').textContent = formatCurrency(totalCollected);
  document.getElementById('monthlyCollections').textContent = formatCurrency(monthlyCollections);
  document.getElementById('finesCollected').textContent = formatCurrency(finesCollected);
  document.getElementById('transportMoney').textContent = formatCurrency(transportMoney);
}

// Form Submission
memberForm.addEventListener('submit', e => {
  e.preventDefault();
  const memberNumber = document.getElementById('memberNumber').value.trim();
  const name = document.getElementById('name').value.trim();
  const idNumber = document.getElementById('idNumber').value.trim();
  const phone = document.getElementById('phone').value.trim();
  
  if(!name || !idNumber || !phone){ 
    return; 
  }

  const memberObj = { 
    memberNumber: memberNumber || generateMemberNumber(), 
    name, 
    idNumber, 
    phone,
    beneficiaries: []
  };

  if(editIndex >= 0){
    members[editIndex] = {...members[editIndex], ...memberObj};
    editIndex = -1;
    memberSubmit.innerHTML = '<i class="fas fa-plus"></i> Add Member';
    memberSubmit.classList.remove('update-btn-blue');
    memberSubmit.classList.add('add-btn-green');
  } else {
    members.push(memberObj);
  }
  
  saveMembers();
  renderMembers(searchInput.value.trim());
  updatePaymentMemberDropdown();
  memberForm.reset();
  showToast('Member saved successfully!');
});

// Search functionality
searchInput.addEventListener('input', () => {
  renderMembers(searchInput.value.trim());
});

// Payment search functionality
paymentSearch.addEventListener('input', () => {
  renderPayments(paymentSearch.value.trim());
});

// NEW: Attendance search functionality
attendanceSearch.addEventListener('input', () => {
  loadAttendance(attendanceSearch.value.trim());
});

// Attendance event listeners
if (attendanceDateInput) {
  attendanceDateInput.addEventListener('change', function() {
    // Save current selection for previous month/date before switching
    try { saveAttendanceData(); } catch (e) { /* ignore save errors */ }
    loadAttendance();
  });
}
saveAttendanceBtn.addEventListener('click', saveAttendanceData);

// Initialize the system
document.addEventListener('DOMContentLoaded', function() {
  renderMembers('');
  updatePaymentMemberDropdown();
  renderPayments();
  updatePaymentSummary();
  
  // Set default date to today
  document.getElementById('paymentDate').valueAsDate = new Date();
  
  // Initialize expandable sections
  setTimeout(initializeExpandableSections, 500);
  
  // Initialize attendance
  initializeAttendance();
  
  showToast('System loaded successfully!');
});

// Modal functions
function openEditChoiceModal(index) {
  currentMemberIndex = index;
  document.getElementById('editChoiceModal').style.display = 'flex';
}

function openDeleteModal(index) {
  deleteIndex = index;
  document.getElementById('deleteModal').style.display = 'flex';
}

// FIXED: Add Beneficiary Modal
function openAddBeneficiaryModal(index) {
  currentMemberIndex = index;
  
  // Clear previous inputs
  document.getElementById('beneficiaryName').value = '';
  document.getElementById('beneficiaryId').value = '';
  document.getElementById('beneficiaryRelationship').value = '';
  
  document.getElementById('addBenModal').style.display = 'flex';
}

// FIXED: Save Beneficiary
document.getElementById('addBenSave').addEventListener('click', function() {
  if (currentMemberIndex === null) return;
  
  const name = document.getElementById('beneficiaryName').value.trim();
  const id = document.getElementById('beneficiaryId').value.trim();
  const relationship = document.getElementById('beneficiaryRelationship').value.trim();
  
  if (!name || !id || !relationship) {
    alert('Please fill in all beneficiary fields');
    return;
  }
  
  const beneficiary = {
    name,
    id,
    relationship
  };
  
  members[currentMemberIndex].beneficiaries.push(beneficiary);
  saveMembers();
  renderMembers(searchInput.value.trim());
  document.getElementById('addBenModal').style.display = 'none';
  currentMemberIndex = null;
  
  showToast('Beneficiary added successfully!');
});

// Edit Beneficiaries Modal
function openEditBeneficiariesModal(index) {
  currentMemberIndex = index;
  const member = members[index];
  
  const modalBenContainer = document.getElementById('modalBenContainer');
  modalBenContainer.innerHTML = '';
  
  // Add existing beneficiaries
  member.beneficiaries.forEach((ben, i) => {
    const row = document.createElement('div');
    row.style.display = 'flex';
    row.style.gap = '0.5rem';
    row.innerHTML = `
      <input type="text" value="${escHtml(ben.name)}" placeholder="Name" class="modal-input" data-index="${i}" data-field="name">
      <input type="text" value="${escHtml(ben.id)}" placeholder="ID Number" class="modal-input" data-index="${i}" data-field="id">
      <input type="text" value="${escHtml(ben.relationship)}" placeholder="Relationship" class="modal-input" data-index="${i}" data-field="relationship">
      <button class="btn btn-red delete-beneficiary" data-index="${i}"><i class="fas fa-trash"></i></button>
    `;
    modalBenContainer.appendChild(row);
  });
  
  document.getElementById('editBenModal').style.display = 'flex';
}

// Save Beneficiary Changes
document.getElementById('modalSaveBen').addEventListener('click', function() {
  if (currentMemberIndex === null) return;
  
  const member = members[currentMemberIndex];
  const inputs = document.querySelectorAll('#modalBenContainer input');
  
  // Update beneficiaries
  inputs.forEach(input => {
    const index = parseInt(input.getAttribute('data-index'));
    const field = input.getAttribute('data-field');
    const value = input.value.trim();
    
    if (member.beneficiaries[index]) {
      member.beneficiaries[index][field] = value;
    }
  });
  
  saveMembers();
  renderMembers(searchInput.value.trim());
  document.getElementById('editBenModal').style.display = 'none';
  currentMemberIndex = null;
  
  showToast('Beneficiaries updated successfully!');
});

// Add new beneficiary row
document.getElementById('modalAddRow').addEventListener('click', function() {
  const member = members[currentMemberIndex];
  const newIndex = member.beneficiaries.length;
  
  member.beneficiaries.push({
    name: '',
    id: '',
    relationship: ''
  });
  
  const row = document.createElement('div');
  row.style.display = 'flex';
  row.style.gap = '0.5rem';
  row.innerHTML = `
    <input type="text" placeholder="Name" class="modal-input" data-index="${newIndex}" data-field="name">
    <input type="text" placeholder="ID Number" class="modal-input" data-index="${newIndex}" data-field="id">
    <input type="text" placeholder="Relationship" class="modal-input" data-index="${newIndex}" data-field="relationship">
    <button class="btn btn-red delete-beneficiary" data-index="${newIndex}"><i class="fas fa-trash"></i></button>
  `;
  document.getElementById('modalBenContainer').appendChild(row);
});

// Delete beneficiary
document.addEventListener('click', function(e) {
  if (e.target.classList.contains('delete-beneficiary') || 
      e.target.parentElement.classList.contains('delete-beneficiary')) {
    const btn = e.target.classList.contains('delete-beneficiary') ? e.target : e.target.parentElement;
    const index = parseInt(btn.getAttribute('data-index'));
    
    if (currentMemberIndex !== null) {
      members[currentMemberIndex].beneficiaries.splice(index, 1);
      openEditBeneficiariesModal(currentMemberIndex); // Refresh the modal
    }
  }
});

// Edit choice modal handlers
document.getElementById('choiceEditMember').addEventListener('click', function() {
  document.getElementById('editChoiceModal').style.display = 'none';
  if (currentMemberIndex !== null) {
    openEditMemberModal(currentMemberIndex);
  }
});

document.getElementById('choiceEditBen').addEventListener('click', function() {
  document.getElementById('editChoiceModal').style.display = 'none';
  if (currentMemberIndex !== null) {
    openEditBeneficiariesModal(currentMemberIndex);
  }
});

document.getElementById('choiceCancel').addEventListener('click', function() {
  document.getElementById('editChoiceModal').style.display = 'none';
  currentMemberIndex = null;
});

// Close modals when clicking cancel buttons
document.querySelectorAll('.btn-ghost').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.modal').forEach(modal => {
      modal.style.display = 'none';
    });
  });
});

// Cancel buttons for new modals
document.getElementById('cancelPaymentEdit').addEventListener('click', function() {
  document.getElementById('paymentEditModal').style.display = 'none';
  editPaymentIndex = null;
});

document.getElementById('cancelPaymentDelete').addEventListener('click', function() {
  document.getElementById('paymentDeleteModal').style.display = 'none';
  deletePaymentIndex = null;
});

document.getElementById('cancelMemberEdit').addEventListener('click', function() {
  document.getElementById('editMemberModal').style.display = 'none';
  currentMemberIndex = null;
});

document.getElementById('addBenCancel').addEventListener('click', function() {
  document.getElementById('addBenModal').style.display = 'none';
  currentMemberIndex = null;
});

document.getElementById('modalCancelBen').addEventListener('click', function() {
  document.getElementById('editBenModal').style.display = 'none';
  currentMemberIndex = null;
});

// NEW: Generate Fines Report with due/paid status
function generateFinesReport() {
  const finesContainer = document.getElementById('finesContainer');
  finesContainer.innerHTML = '';
  
  // Get all payments with fines
  const finesPayments = payments.filter(payment => payment.fines && payment.fines.trim() !== '');
  
  // Separate due and paid fines
  const dueFines = finesPayments.filter(payment => payment.fines.includes(' - Due'));
  const paidFines = finesPayments.filter(payment => payment.fines.includes(' - Paid'));
  
  // Calculate statistics
  const totalFines = paidFines.reduce((sum, payment) => sum + extractAmountFromString(payment.fines), 0);
  const totalDue = dueFines.reduce((sum, payment) => {
    // For due fines, we don't have amounts, so we'll estimate based on fine type
    const fineType = payment.fines.split(' - ')[0];
    let estimatedAmount = 0;
    switch(fineType) {
      case 'Late Coming': estimatedAmount = 30; break;
      case 'Swearing': estimatedAmount = 50; break;
      case 'Absence': estimatedAmount = 50; break;
      case 'Misconduct': estimatedAmount = 100; break;
      default: estimatedAmount = 50;
    }
    return sum + estimatedAmount;
  }, 0);
  
  const finesSummary = document.createElement('div');
  finesSummary.className = 'summary-cards';
  finesSummary.innerHTML = `
    <div class="summary-card">
      <h3>Total Fines Collected</h3>
      <div class="amount">${formatCurrency(totalFines)}</div>
    </div>
    <div class="summary-card">
      <h3>Fines Due</h3>
      <div class="amount" style="color: var(--accent);">${formatCurrency(totalDue)}</div>
    </div>
    <div class="summary-card">
      <h3>Paid Fines</h3>
      <div class="amount">${paidFines.length}</div>
    </div>
    <div class="summary-card">
      <h3>Due Fines</h3>
      <div class="amount" style="color: var(--accent);">${dueFines.length}</div>
    </div>
  `;
  finesContainer.appendChild(finesSummary);
  
  // Create tabs for due and paid fines
  const finesTabs = document.createElement('div');
  finesTabs.className = 'transport-tabs';
  finesTabs.innerHTML = `
    <div class="transport-tab active" data-tab="due">Due Fines</div>
    <div class="transport-tab" data-tab="paid">Paid Fines</div>
  `;
  finesContainer.appendChild(finesTabs);
  
  // Create tab content containers
  const dueFinesContainer = document.createElement('div');
  dueFinesContainer.className = 'transport-tab-content active';
  dueFinesContainer.id = 'finesDueContainer';
  
  const paidFinesContainer = document.createElement('div');
  paidFinesContainer.className = 'transport-tab-content';
  paidFinesContainer.id = 'finesPaidContainer';
  
  finesContainer.appendChild(dueFinesContainer);
  finesContainer.appendChild(paidFinesContainer);
  
  // Update due fines tab
  updateFinesDueTab(dueFines);
  
  // Update paid fines tab
  updateFinesPaidTab(paidFines);
  
  // Add tab functionality
  finesTabs.querySelectorAll('.transport-tab').forEach(tab => {
    tab.addEventListener('click', function() {
      const tabName = this.getAttribute('data-tab');
      
      // Update active tab
      finesTabs.querySelectorAll('.transport-tab').forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      
      // Show active content
      finesContainer.querySelectorAll('.transport-tab-content').forEach(content => {
        content.classList.remove('active');
      });
      finesContainer.querySelector(`#fines${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Container`).classList.add('active');
    });
  });
}

// NEW: Update Fines Due Tab
function updateFinesDueTab(dueFines) {
  const finesDueContainer = document.getElementById('finesDueContainer');
  finesDueContainer.innerHTML = '';
  
  if (dueFines.length === 0) {
    finesDueContainer.innerHTML = `
      <div style="text-align: center; padding: 3rem; background: var(--card-bg); border-radius: 12px; box-shadow: var(--shadow);">
        <i class="fas fa-check-circle" style="font-size: 3rem; color: var(--success); margin-bottom: 1rem;"></i>
        <h3 style="color: var(--success); margin-bottom: 1rem;">No Due Fines</h3>
        <p class="small-muted">All fines have been paid.</p>
      </div>
    `;
    return;
  }
  
  const tableSection = document.createElement('div');
  tableSection.innerHTML = `
    <h3 style="margin: 2rem 0 1rem 0; color: var(--secondary);">
      <i class="fas fa-list"></i> Due Fines
    </h3>
    <table>
      <thead>
        <tr>
          <th>Member</th>
          <th>Date</th>
          <th>Fine Type</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        ${dueFines.map(payment => `
          <tr class="flagged-member">
            <td>${payment.name} ${payment.surname}</td>
            <td>${payment.date}</td>
            <td>${payment.fines.split(' - ')[0]}</td>
            <td>
              <span class="payment-status status-overdue">Due</span>
            </td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
  finesDueContainer.appendChild(tableSection);
}

// NEW: Update Fines Paid Tab
function updateFinesPaidTab(paidFines) {
  const finesPaidContainer = document.getElementById('finesPaidContainer');
  finesPaidContainer.innerHTML = '';
  
  if (paidFines.length === 0) {
    finesPaidContainer.innerHTML = `
      <div style="text-align: center; padding: 3rem; background: var(--card-bg); border-radius: 12px; box-shadow: var(--shadow);">
        <i class="fas fa-info-circle" style="font-size: 3rem; color: var(--warning); margin-bottom: 1rem;"></i>
        <h3 style="color: var(--warning); margin-bottom: 1rem;">No Paid Fines</h3>
        <p class="small-muted">No fines have been paid yet.</p>
      </div>
    `;
    return;
  }
  
  const tableSection = document.createElement('div');
  tableSection.innerHTML = `
    <h3 style="margin: 2rem 0 1rem 0; color: var(--secondary);">
      <i class="fas fa-list"></i> Paid Fines
    </h3>
    <table>
      <thead>
        <tr>
          <th>Member</th>
          <th>Date</th>
          <th>Fine Type</th>
          <th>Amount</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        ${paidFines.map(payment => `
          <tr>
            <td>${payment.name} ${payment.surname}</td>
            <td>${payment.date}</td>
            <td>${payment.fines.split(' (')[0]}</td>
            <td>${formatCurrency(extractAmountFromString(payment.fines))}</td>
            <td>
              <span class="payment-status status-paid">Paid</span>
            </td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
  finesPaidContainer.appendChild(tableSection);
}

// NEW: Export to PDF functionality
function exportToPDF(data, headers, filename, title) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  // Add title
  doc.setFontSize(16);
  doc.text(title, 14, 15);
  doc.setFontSize(12);
  doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 14, 22);
  
  // Add table to PDF
  doc.autoTable({
    head: [headers],
    body: data,
    startY: 30,
    styles: { fontSize: 8 },
    headStyles: { fillColor: [52, 152, 219] }
  });
  
  // Save the PDF
  doc.save(`${filename}.pdf`);
}

// NEW: Export to Excel functionality
function exportToExcel(data, headers, filename, title) {
  // Create worksheet
  const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
  
  // Create workbook and append worksheet
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
  
  // Write file
  XLSX.writeFile(wb, `${filename}.xlsx`);
}

// NEW: Export Members Data
function exportMembersData(format) {
  const headers = ['Member Number', 'Full Name', 'ID Number', 'Phone', 'Beneficiaries Count'];
  
  const data = members.map(member => [
    member.memberNumber || 'N/A',
    member.name,
    member.idNumber,
    member.phone,
    member.beneficiaries ? member.beneficiaries.length : 0
  ]);
  
  if (format === 'pdf') {
    exportToPDF(data, headers, 'members', 'Tshilapfene Burial Society - Members Report');
    showToast('Members exported to PDF successfully!');
  } else {
    exportToExcel(data, headers, 'members', 'Tshilapfene Burial Society - Members Report');
    showToast('Members exported to Excel successfully!');
  }
}

// NEW: Export Payments Data
function exportPaymentsData(format) {
  const headers = ['Book No', 'Name', 'Surname', 'Date', 'Monthly Collections', 'Dress Code', 'Fines', 'Transport', 'Total Payment'];
  
  const data = payments.map(payment => [
    payment.bookNo || '',
    payment.name,
    payment.surname,
    payment.date,
    formatCurrency(payment.monthlyCollection),
    payment.dressCode,
    payment.fines,
    formatCurrency(payment.transport),
    formatCurrency(payment.totalPayment)
  ]);
  
  if (format === 'pdf') {
    exportToPDF(data, headers, 'payments', 'Tshilapfene Burial Society - Payments Report');
    showToast('Payments exported to PDF successfully!');
  } else {
    exportToExcel(data, headers, 'payments', 'Tshilapfene Burial Society - Payments Report');
    showToast('Payments exported to Excel successfully!');
  }
}

// NEW: Export Reports Data
function exportReportsData(format) {
  const headers = ['Report Type', 'Generated Date', 'Summary Data'];
  
  const data = [
    ['Members Count', new Date().toLocaleDateString(), members.length],
    ['Payments Count', new Date().toLocaleDateString(), payments.length],
    ['Total Collections', new Date().toLocaleDateString(), formatCurrency(payments.reduce((sum, p) => sum + (p.totalPayment || 0), 0))],
    ['Red Flagged Members', new Date().toLocaleDateString(), checkRedFlagMembers().length]
  ];
  
  if (format === 'pdf') {
    exportToPDF(data, headers, 'reports_summary', 'Tshilapfene Burial Society - Reports Summary');
    showToast('Reports exported to PDF successfully!');
  } else {
    exportToExcel(data, headers, 'reports_summary', 'Tshilapfene Burial Society - Reports Summary');
    showToast('Reports exported to Excel successfully!');
  }
}

// NEW: Export Statements Data
function exportStatementsData(format) {
  const headers = ['Month', 'Total Collections', 'Fines Collected', 'Transport Fees', 'Member Count'];
  
  // Group by month
  const monthlyData = {};
  payments.forEach(payment => {
    const date = new Date(payment.date);
    const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
    
    if (!monthlyData[monthYear]) {
      monthlyData[monthYear] = {
        month: date.toLocaleString('default', { month: 'long', year: 'numeric' }),
        total: 0,
        fines: 0,
        transport: 0,
        count: 0
      };
    }
    
    monthlyData[monthYear].total += parseFloat(payment.monthlyCollection || 0);
    monthlyData[monthYear].fines += extractAmountFromString(payment.fines);
    monthlyData[monthYear].transport += parseFloat(payment.transport || 0);
    monthlyData[monthYear].count++;
  });
  
  const data = Object.values(monthlyData).map(month => [
    month.month,
    formatCurrency(month.total),
    formatCurrency(month.fines),
    formatCurrency(month.transport),
    month.count
  ]);
  
  if (format === 'pdf') {
    exportToPDF(data, headers, 'statements', 'Tshilapfene Burial Society - Statements Report');
    showToast('Statements exported to PDF successfully!');
  } else {
    exportToExcel(data, headers, 'statements', 'Tshilapfene Burial Society - Statements Report');
    showToast('Statements exported to Excel successfully!');
  }
}

// NEW: Export Fines Data
function exportFinesData(format) {
  const headers = ['Member', 'Date', 'Fine Type', 'Amount', 'Status'];
  
  const finesPayments = payments.filter(payment => payment.fines && payment.fines.trim() !== '');
  
  const data = finesPayments.map(payment => {
    const isDue = payment.fines.includes(' - Due');
    const amount = isDue ? 'Due' : formatCurrency(extractAmountFromString(payment.fines));
    const fineType = payment.fines.split(' - ')[0].split(' (')[0];
    
    return [
      `${payment.name} ${payment.surname}`,
      payment.date,
      fineType,
      amount,
      isDue ? 'Due' : 'Paid'
    ];
  });
  
  if (format === 'pdf') {
    exportToPDF(data, headers, 'fines', 'Tshilapfene Burial Society - Fines Report');
    showToast('Fines exported to PDF successfully!');
  } else {
    exportToExcel(data, headers, 'fines', 'Tshilapfene Burial Society - Fines Report');
    showToast('Fines exported to Excel successfully!');
  }
}

// NEW: Export Red Flags Data
function exportRedFlagsData(format) {
  const headers = ['Member Number', 'Full Name', 'ID Number', 'Phone', 'Last Payment', 'Status'];
  
  const redFlagMembers = checkRedFlagMembers();
  
  const data = redFlagMembers.map(member => [
    member.memberNumber,
    member.name,
    member.idNumber,
    member.phone,
    member.lastPayment ? member.lastPayment.toLocaleDateString() : 'Never',
    'Overdue'
  ]);
  
  if (format === 'pdf') {
    exportToPDF(data, headers, 'red_flags', 'Tshilapfene Burial Society - Red Flagged Members Report');
    showToast('Red flags exported to PDF successfully!');
  } else {
    exportToExcel(data, headers, 'red_flags', 'Tshilapfene Burial Society - Red Flagged Members Report');
    showToast('Red flags exported to Excel successfully!');
  }
}

// NEW: Export Transport Data
function exportTransportData(format) {
  const headers = ['Member', 'Date', 'Transport Fee', 'Funeral For', 'Status'];
  
  const transportPayments = payments.filter(payment => parseFloat(payment.transport || 0) > 0);
  
  const data = transportPayments.map(payment => [
    `${payment.name} ${payment.surname}`,
    payment.date,
    formatCurrency(payment.transport),
    payment.funeralFor || 'Not specified',
    payment.isDue ? 'Unpaid' : 'Paid'
  ]);
  
  if (format === 'pdf') {
    exportToPDF(data, headers, 'transport', 'Tshilapfene Burial Society - Transport Payments Report');
    showToast('Transport data exported to PDF successfully!');
  } else {
    exportToExcel(data, headers, 'transport', 'Tshilapfene Burial Society - Transport Payments Report');
    showToast('Transport data exported to Excel successfully!');
  }
}

// NEW: Export Attendance Data
function exportAttendanceData(format) {
  const headers = ['Month', 'Members Present', 'Total Membership', 'Attendance Rate'];
  
  const data = Object.keys(attendance).map(key => {
    const [year, month] = key.split('-');
    const monthName = new Date(year, month - 1).toLocaleString('default', { month: 'long', year: 'numeric' });
    const present = attendance[key].length;
    const total = members.length;
    const rate = total > 0 ? ((present / total) * 100).toFixed(1) : 0;
    
    return [monthName, present, total, `${rate}%`];
  });
  
  const title = 'Attendance - Members';
  if (format === 'pdf') {
    exportToPDF(data, headers, 'attendance', `Tshilapfene Burial Society - ${title}`);
    showToast('Attendance exported to PDF successfully!');
  } else {
    exportToExcel(data, headers, 'attendance', `Tshilapfene Burial Society - ${title}`);
    showToast('Attendance exported to Excel successfully!');
  }
}

// Set up all export buttons
document.getElementById('exportPDF').addEventListener('click', () => exportMembersData('pdf'));
document.getElementById('exportExcel').addEventListener('click', () => exportMembersData('excel'));

document.getElementById('exportPaymentsPDF').addEventListener('click', () => exportPaymentsData('pdf'));
document.getElementById('exportPaymentsExcel').addEventListener('click', () => exportPaymentsData('excel'));

document.getElementById('exportReportsPDF').addEventListener('click', () => exportReportsData('pdf'));
document.getElementById('exportReportsExcel').addEventListener('click', () => exportReportsData('excel'));

document.getElementById('exportStatementsPDF').addEventListener('click', () => exportStatementsData('pdf'));
document.getElementById('exportStatementsExcel').addEventListener('click', () => exportStatementsData('excel'));

document.getElementById('exportFinesPDF').addEventListener('click', () => exportFinesData('pdf'));
document.getElementById('exportFinesExcel').addEventListener('click', () => exportFinesData('excel'));

document.getElementById('exportRedflagsPDF').addEventListener('click', () => exportRedFlagsData('pdf'));
document.getElementById('exportRedflagsExcel').addEventListener('click', () => exportRedFlagsData('excel'));

document.getElementById('exportTransportPDF').addEventListener('click', () => exportTransportData('pdf'));
document.getElementById('exportTransportExcel').addEventListener('click', () => exportTransportData('excel'));

document.getElementById('exportAttendancePDF').addEventListener('click', () => exportAttendanceData('pdf'));
document.getElementById('exportAttendanceExcel').addEventListener('click', () => exportAttendanceData('excel'));

document.getElementById('exportAttendanceReportPDF').addEventListener('click', () => exportAttendanceData('pdf'));
document.getElementById('exportAttendanceReportExcel').addEventListener('click', () => exportAttendanceData('excel'));

// NEW: Export functionality for the new pages
document.getElementById('exportMonthlyPDF').addEventListener('click', () => exportMonthlyData('pdf'));
document.getElementById('exportMonthlyExcel').addEventListener('click', () => exportMonthlyData('excel'));

document.getElementById('exportYearlyPDF').addEventListener('click', () => exportYearlyData('pdf'));
document.getElementById('exportYearlyExcel').addEventListener('click', () => exportYearlyData('excel'));

// Export functions for the new pages
function exportMonthlyData(format) {
  const headers = ['Month', 'Total Collections', 'Fines Collected', 'Transport Fees', 'Member Count'];
  
  // Group by month
  const monthlyData = {};
  payments.forEach(payment => {
    const date = new Date(payment.date);
    const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
    
    if (!monthlyData[monthYear]) {
      monthlyData[monthYear] = {
        month: date.toLocaleString('default', { month: 'long', year: 'numeric' }),
        total: 0,
        fines: 0,
        transport: 0,
        count: 0
      };
    }
    
    monthlyData[monthYear].total += parseFloat(payment.monthlyCollection || 0);
    monthlyData[monthYear].fines += extractAmountFromString(payment.fines);
    monthlyData[monthYear].transport += parseFloat(payment.transport || 0);
    monthlyData[monthYear].count++;
  });
  
  const data = Object.values(monthlyData).map(month => [
    month.month,
    formatCurrency(month.total),
    formatCurrency(month.fines),
    formatCurrency(month.transport),
    month.count
  ]);
  
  if (format === 'pdf') {
    exportToPDF(data, headers, 'monthly_collections', 'Tshilapfene Burial Society - Monthly Collections Report');
    showToast('Monthly collections exported to PDF successfully!');
  } else {
    exportToExcel(data, headers, 'monthly_collections', 'Tshilapfene Burial Society - Monthly Collections Report');
    showToast('Monthly collections exported to Excel successfully!');
  }
}

function exportYearlyData(format) {
  const headers = ['Year', 'Total Collections', 'Fines Collected', 'Transport Fees', 'Member Count'];
  
  // Group by year
  const yearlyData = {};
  payments.forEach(payment => {
    const date = new Date(payment.date);
    const year = date.getFullYear().toString();
    
    if (!yearlyData[year]) {
      yearlyData[year] = {
        year: year,
        total: 0,
        fines: 0,
        transport: 0,
        count: 0
      };
    }
    
    yearlyData[year].total += parseFloat(payment.monthlyCollection || 0);
    yearlyData[year].fines += extractAmountFromString(payment.fines);
    yearlyData[year].transport += parseFloat(payment.transport || 0);
    yearlyData[year].count++;
  });
  
  const data = Object.values(yearlyData).map(year => [
    year.year,
    formatCurrency(year.total),
    formatCurrency(year.fines),
    formatCurrency(year.transport),
    year.count
  ]);
  
  if (format === 'pdf') {
    exportToPDF(data, headers, 'yearly_view', 'Tshilapfene Burial Society - Yearly View Report');
    showToast('Yearly view exported to PDF successfully!');
  } else {
    exportToExcel(data, headers, 'yearly_view', 'Tshilapfene Burial Society - Yearly View Report');
    showToast('Yearly view exported to Excel successfully!');
  }
}

// NEW: Generate Attendance Report Button
document.getElementById('generateAttendanceReport').addEventListener('click', function() {
  generateAttendanceReport();
  showToast('Attendance report generated!');
});

// Add CSS for modal inputs
const style = document.createElement('style');
style.textContent = `
  .modal-input {
    padding: 0.8rem 1rem;
    border: 1px solid #555;
    border-radius: 6px;
    background: var(--card-bg);
    color: var(--text);
    font-size: 1rem;
    transition: all 0.3s ease;
  }
  
  .modal-input:focus {
    outline: none;
    border-color: var(--secondary);
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
  }
`;
document.head.appendChild(style);
</script>
</body>
</html>
